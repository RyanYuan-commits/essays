### 1 什么是 HTTPS？
HTTPS（HyperText Transfer Protocol Secure）是一种安全的通信协议，用于在计算机网络上安全地传输超文本（如网页、图像、视频等）和其他数据。它是 HTTP 协议的安全版本，通过使用加密技术来保护通信的安全性和隐私性。
HTTP 协议中的数据是 **明文传输**，存在安全风险。HTTPS 采用了加密传输的方式，在 TCP 和 HTTP 网络层之间加入了 `SSL/TLS` 安全协议，使得报文能够加密传输。HTTPS 在 TCP 三次握手之后，还需进行 `SSL/TLS` 的握手过程，才可进入加密报文传输。
### 2 HTTPS vs HTTP
#### 2.1 HTTP 的安全性问题
HTTP 由于是明文传输，且浏览器和服务端没有认证机制，所以会存在这样的风险：
1. 可以通过抓包获取用户的私密信息；
2. 伪造服务器发送信息；
3. 可以对报文进行篡改。
#### 2.2 SSL/TLS
![[HTTP vs HTTPS.png#pic_center]]
HTTPS 在 HTTP 与 TCP 层之间加入了 `SSL/TLS` 层，可以很好的解决了上述的风险：
- **信息加密**：交互信息无法被窃取；
- **校验机制**：无法篡改通信内容，篡改了就不能正常显示；
- **身份证书**：证明服务器的可靠性。
### 3 混合加密
HTTPS 中的数据是加密传输的，通过抓包无法获取到用户的私密信息。
#### 3.1 对称加密和非对称加密
在正式开始讲解加密的方式之前，这里对「对称加密」和「非对称加密」做一些补充。
##### 对称加密
双方持有两个相同的密钥，双方对数据进行加密和解密都使用这个密钥；它的有点就是加密算法计算复杂度低，也就是加密和解密的速度很快，但是由于双方都需要安全的共享和管理密钥，且一旦密钥泄露整个加密系统的安全就会收到影响，复杂度低，比较适合大量数据的加密。
##### 非对称加密
使用**一对密钥**：公钥和私钥，公钥用于加密数据，私钥用于解密数据，因为加密和解密使用的密钥是不同的，所以这种方式被称为 **非对称加密**；这种方式的安全性比较高，只有持有私钥的一方才能解密数据，但是非对称加密算法计算复杂度较高加密速度慢，适用于小数据量的加密。
非对称加密的过程是这样的：
- 发送送方使用**接收方的公钥**对明文进行加密，生成密文。
- 发送方将密文发送给接收方。
- 接收方使用自己的私钥对密文进行解密，恢复出明文。
非对称加密还有一种方式名为 **数字签名**，通过数字签名，接收方可以感知到数据是否被篡改；
例如，发送方可以通过对发送内容取哈希值，再通过公钥加密，接收方通过相同的算法再次计算内容的哈希值，与解密的数字签名中的哈希值做比对，这样就能感知到数据在传输过程中是否被篡改。
非对称加密是用于需要安全交换密钥的场景，如 SSL/TLS 协议中的密钥交换、数字签名、身份认证等，这样小规模数据的加密。
#### 3.2 混合加密
HTTPS 采用了 **对称加密 + 非对称加密** 的混合方法来加密双方的通信。
为什么要采用混合加密的方法呢？无论使用哪种方法，双方都要去 **互通** 密钥，而互通密钥是需要经过网络的，那这个数据就有可能被拦截，带来了伪造消息等风险。
所以要保证 **正式对话** 的时候使用的密钥是加密传递的，我们来看看 HTTPS 是怎么做的：
- 当客户端向服务器发送信息的时候，服务器会发送一个可以证明自己身份的 **数字证书**，客户端可以从合法的数字证书中拿到 **公钥**，用户接收到数字证书之后，会先去验证证书的有效性。【服务器——亮明身份】
- 验证成功后，客户端就可以信任服务器的身份；随后，客户端生成一个随机的会话密钥，并使用服务器发送的公钥对会话密钥进行加密。【客户端——公钥加密】
- 客户端发送这个会话密钥给服务器，服务器收到客户端发送的加密后的会话密钥后，使用私钥解密会话密钥。【服务器——私钥解密】
- 客户端和服务器使用已经建立的会话密钥来加密和解密传输的数据，建立安全的通信通道，后续的通信都将使用会话密钥进行加密和解密，保证通信的安全性和隐私性。【安全通信👍】
### 数字证书
#### 3.1 数字证书的作用
如果一开始与我们建立 HTTPS 的服务器其实就是不安全的呢？此时应该如何检验？
前面提到了服务器要有证明自己身份的证书，通过证书来证明了它自己是一个合法合规的服务器，如果使用这种服务器做一些违法的事情，根据证书的注册信息来溯源也会非常简单。
客户端根据证书来验证服务器的可靠性，验证完之后，客户端就知道这个服务器是否靠谱值得信任了。
![[访问的不是私密连接.png|500]]
当服务端的证书不可信的时候，浏览器是可以识别到的，此时就会弹出上面的界面。
#### 3.2 无视风险继续访问
既然浏览器能够认出来证书不正确，那恶意网站为什么还要用 HTTPS 呢？
恶意网站之所以看上 HTTPS，也正是因为它的安全性，由于 HTTPS 设置了数据加密，所以一些防御系统和安全软件更倾向于对 HTTP流量进行深入检查和分析，而对 HTTPS 流量的检查则较少，这对恶意网站来说非常重要，因为它们希望隐藏其恶意活动，如窃取用户数据或传播恶意软件。
#### 3.3 证书认证机构
每个权威的证书背后都要有一个权威的机构，数字证书也不例外，在 HTTPS 的世界中，这个权威的机构就是 CA （数字证书认证机构），注册 CA 证书需要向认证机构提供这些信息：
- 组织信息：组织名称、单位、地址和国家。
- 域名信息：要保护的域名以及域名所有权验证。
- 联系人信息：申请人的姓名、职位、电子邮件和电话号码。
- CSR：生成的证书签名请求文件，包含公钥和组织信息。
只要用户确保操作系统和浏览器的证书信任库是最新的，并且及时更新和管理受信任的CA列表，浏览器就能识别到证书是否有效；
#### 3.4 数字证书的签发和验证
##### 证书的签发
![[数字证书的签发.png|700]]
- **用户生成密钥对**：用户（通常是网站所有者或应用程序开发者）首先使用加密工具生成一对密钥，即公钥和私钥。私钥由用户自己安全保存，公钥将用于后续的证书申请过程。
- **创建证书签名请求（CSR）**：用户将公钥以及相关的身份信息（如域名、组织名称、联系人信息等）打包成一个证书签名请求（CSR）文件。这个文件是向证书颁发机构（CA）申请数字证书的正式请求。
- **提交 CSR 到 CA**：用户将 CSR 文件提交给选定的证书颁发机构（CA）。
- **CA 验证身份信息**：CA 会对用户提交的 CSR 中的身份信息进行严格验证。验证方式可能包括域名所有权验证、组织真实性验证等。例如，通过向域名的管理邮箱发送验证邮件，或者要求提供组织的相关证明文件等。只有在身份信息验证通过后，CA 才会继续签发证书的流程。
- **CA 生成数字证书**：一旦 CA 验证了用户的身份信息，它就会使用自己的私钥对用户的公钥和相关信息进行签名，生成数字证书签名。数字证书中包含了用户的公钥、身份信息、证书的有效期、CA 的签名等内容。
- **颁发数字证书**：CA 将生成好的数字证书发送给用户。用户收到证书后，将其安装在相应的服务器或应用程序中，以便与客户端进行安全的通信。
##### 证书的验证
1. **接收数字证书**：验证者（如客户端）从通信对方（如服务器）处接收到数字证书。
2. **验证证书链**：验证者首先检查数字证书是否由受信任的 CA 签发。如果证书是由受信任的 CA 签发的，则证书被认为是可信的。否则，验证者会继续验证证书链，直到找到根证书为止。
3. **验证证书的有效期**：验证者检查数字证书的有效期，确保当前日期在证书的有效期内。
4. **验证证书的吊销状态**：验证者检查证书是否被吊销。这可以通过证书吊销列表（CRL）或在线证书状态协议（OCSP）来实现。
5. **验证数字签名和哈希值**：验证者使用公钥来验证数字证书的数字签名；CA 会对证书内容进行哈希处理，生成证书内容的哈希值，然后，CA使用其私钥对哈希值进行加密，生成签名。这个签名附加在证书上。如果签名有效，则可以确信证书内容没有被篡改。
6. **可选的附加验证**：根据实际需要，验证者可能会进行其他验证，例如验证证书中的主体信息是否与通信方匹配，或者额外的验证证书中包含的其他信息。
用户对证书的验证其实是一个信任链的过程，即 根证书 => 中间证书 => 实际的证书，证书的签发通常不是由根证书签发的，而是借助中间的证书，客户端在验证的时候只需要查询中间证书是否信任本次发送的证书即可。
当用户收到一个证书的时候，先去检测它的 **上层** 的证书是哪个，直到请求到根证书，而用户会持有一个根证书清单，请求到根证书后回去验证证书是否在这个清单上。
然后再去检测根证书是否信任下层的证书，逐次检查直到检查到服务器发送来的证书，这样就能验证证书的有效性了。