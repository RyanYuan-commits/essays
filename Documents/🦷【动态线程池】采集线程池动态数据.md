# é¡¹ç›®ç»“æ„
- é¡¹ç›®åœ°å€ï¼š[https://github.com/KkQ36/dynamic-thread-pool/tree/20241022-get-thread-param](https://github.com/KkQ36/dynamic-thread-pool/tree/20241022-get-thread-param)
- åˆ†æ”¯ï¼š`20241022-get-thread-param`
>[!info] dynamic-thread-pool-starter
```
â”œâ”€â”€ dynamic-thread-pool-starter
â”‚Â Â  â”œâ”€â”€ pom.xml
â”‚Â Â  â””â”€â”€ src
â”‚Â Â      â”œâ”€â”€ main
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ java
â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ com
â”‚Â Â      â”‚Â Â  â”‚Â Â      â””â”€â”€ ryan
â”‚Â Â      â”‚Â Â  â”‚Â Â          â””â”€â”€ sdk
â”‚Â Â      â”‚Â Â  â”‚Â Â              â”œâ”€â”€ config
â”‚Â Â      â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ DynamicThreadPoolAutoConfig.java
â”‚Â Â      â”‚Â Â  â”‚Â Â              â”‚Â Â  â””â”€â”€ DynamicThreadPoolAutoProperties.java
â”‚Â Â      â”‚Â Â  â”‚Â Â              â”œâ”€â”€ domain
â”‚Â Â      â”‚Â Â  â”‚Â Â              â”œâ”€â”€ registry
â”‚Â Â      â”‚Â Â  â”‚Â Â              â””â”€â”€ trigger
â”‚Â Â      â”‚Â Â  â””â”€â”€ resources
â”‚Â Â      â”‚Â Â      â””â”€â”€ META-INF
â”‚Â Â      â”‚Â Â          â””â”€â”€ spring.factories
â”‚Â Â      â””â”€â”€ test
â”‚Â Â          â””â”€â”€ java
```

>[!info] dynamic-thread-pool-test
```
â”œâ”€â”€ dynamic-thread-pool-test
â”‚Â Â  â”œâ”€â”€ pom.xml
â”‚Â Â  â””â”€â”€ src
â”‚Â Â      â”œâ”€â”€ main
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ java
â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ com
â”‚Â Â      â”‚Â Â  â”‚Â Â      â””â”€â”€ ryan
â”‚Â Â      â”‚Â Â  â”‚Â Â          â”œâ”€â”€ Main80.java
â”‚Â Â      â”‚Â Â  â”‚Â Â          â””â”€â”€ config
â”‚Â Â      â”‚Â Â  â”‚Â Â              â”œâ”€â”€ ThreadPoolConfig.java
â”‚Â Â      â”‚Â Â  â”‚Â Â              â””â”€â”€ ThreadPoolConfigProperties.java
â”‚Â Â      â”‚Â Â  â””â”€â”€ resources
â”‚Â Â      â”‚Â Â      â”œâ”€â”€ application-dev.yml
â”‚Â Â      â”‚Â Â      â””â”€â”€ application.yml
â”‚Â Â      â””â”€â”€ test
â”‚Â Â          â””â”€â”€ java
â”‚Â Â              â””â”€â”€ com
â”‚Â Â                  â””â”€â”€ ryan
â”‚Â Â                      â””â”€â”€ TestApi.java
â””â”€â”€ pom.xml
```

# è¦ç‚¹è®°å½•
## å®ç°åŸç†
è¦å®ç°ä¸€ä¸ªåŠ¨æ€çº¿ç¨‹æ± ï¼Œå¹¶ä¸æ˜¯è¯´è¦å»é‡å†™ä¸€ä¸ªçº¿ç¨‹æ± çš„ä»£ç ï¼›Java è‡ªå¸¦çš„çº¿ç¨‹æ±  `ThreadPoolExecutor` å·²ç»æä¾›äº†è¿è¡Œæ—¶é…ç½®çš„åŠŸèƒ½ï¼Œå…·ä½“æ¥è¯´ï¼Œæ˜¯æä¾›äº†è¿™æ ·ä¸€äº› `public` çš„ `setter` æ–¹æ³•ï¼š
![[Pasted image 20241022090116.png]]
ä½†æ˜¯è¿è¡Œæ—¶çš„çº¿ç¨‹æ± ç›‘æ§æ˜¯æ²¡æœ‰æä¾›ä¸€ä¸ªå¾ˆå¥½çš„å®ç°æ–¹å¼çš„ï¼Œæ‰€ä»¥ï¼Œå³ä½¿æä¾›äº†è¿è¡Œæ—¶ä¿®æ”¹é…ç½®çš„åŠŸèƒ½ï¼Œä½†å¦‚ä½•é…ç½®ï¼Ÿä½•æ—¶é…ç½®å´æˆäº†é—®é¢˜ã€‚
åŠ¨æ€çº¿ç¨‹æ± è¦æä¾›çš„æ­£æ˜¯è¿™æ ·çš„åŠŸèƒ½ï¼šå¯¹çº¿ç¨‹æ± çŠ¶æ€çš„è§‚å¯Ÿ ä»¥åŠ ä¾¿æ·çš„çº¿ç¨‹æ± é…ç½®ã€‚

JDK å…è®¸çº¿ç¨‹æ± ä½¿ç”¨æ–¹é€šè¿‡ ThreadPoolExecutor çš„å®ä¾‹æ¥åŠ¨æ€è®¾ç½®çº¿ç¨‹æ± çš„æ ¸å¿ƒç­–ç•¥ï¼Œä»¥ setCorePoolSize ä¸ºæ–¹æ³•ä¾‹ï¼Œåœ¨è¿è¡ŒæœŸçº¿ç¨‹æ± ä½¿ç”¨æ–¹è°ƒç”¨æ­¤æ–¹æ³•è®¾ç½® corePoolSize ä¹‹åï¼Œçº¿ç¨‹æ± ä¼šç›´æ¥è¦†ç›–åŸæ¥çš„corePoolSize å€¼ï¼Œå¹¶ä¸”åŸºäºå½“å‰å€¼å’ŒåŸå§‹å€¼çš„æ¯”è¾ƒç»“æœé‡‡å–ä¸åŒçš„å¤„ç†ç­–ç•¥ã€‚
å¯¹äºå½“å‰å€¼å°äºå½“å‰å·¥ä½œçº¿ç¨‹æ•°çš„æƒ…å†µï¼Œè¯´æ˜æœ‰å¤šä½™çš„ worker çº¿ç¨‹ï¼Œæ­¤æ—¶ä¼šå‘å½“å‰ idle çš„ worker çº¿ç¨‹å‘èµ·ä¸­æ–­è¯·æ±‚ä»¥å®ç°å›æ”¶ï¼Œå¤šä½™çš„ worker åœ¨ä¸‹æ¬¡ idel çš„æ—¶å€™ä¹Ÿä¼šè¢«å›æ”¶ï¼›å¯¹äºå½“å‰å€¼å¤§äºåŸå§‹å€¼ä¸”å½“å‰é˜Ÿåˆ—ä¸­æœ‰å¾…æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™çº¿ç¨‹æ± ä¼šåˆ›å»ºæ–°çš„ worker çº¿ç¨‹æ¥æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡ï¼ŒsetCorePoolSize ç­‰æ–¹æ³•çš„å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š
[[ğŸ—ã€Javaã€‘çº¿ç¨‹æ± çš„åŠ¨æ€ä¿®æ”¹]]
## SpringBoot è‡ªåŠ¨é…ç½®
ä¸ºäº†è®© SpringBoot åœ¨å¯åŠ¨çš„æ—¶å€™å¯ä»¥è‡ªåŠ¨è£…é…æˆ‘ä»¬çš„é…ç½®ç±»ï¼Œéœ€è¦åšè¿™æ ·é…ç½®ï¼š
>[!info] resources.META-INF.spring.factories
```java
org.springframework.boot.autoconfigure.EnableAutoConfiguration=com.ryan.sdk.config.DynamicThreadPoolAutoConfig
```
å¦‚æœéœ€è¦é…ç½®å¤šä¸ªè‡ªåŠ¨é…ç½®ç±»çš„è¯ï¼Œå¯ä»¥é‡‡ç”¨è¿™æ ·çš„æ–¹å¼
```java
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
	com.ryan.sdk.config.DynamicThreadPoolAutoConfig,\
	com.example.config.AnotherAutoConfig
```
åœ¨ Spring Boot 3.0 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œ`org.springframework.boot.autoconfigure.AutoConfiguration.imports` æ–‡ä»¶æ˜¯ç”¨æ¥æ›¿ä»£ spring.factories æ–‡ä»¶ä¸­ EnableAutoConfiguration æ¡ç›®çš„ã€‚å®ƒç”¨äºæŒ‡å®šéœ€è¦è‡ªåŠ¨é…ç½®çš„ç±»åˆ—è¡¨ã€‚
è¿™ä¸ªæ–‡ä»¶çš„æ ¼å¼éå¸¸ç®€å•ï¼Œæ¯è¡Œä¸€ä¸ªç±»åã€‚ä¾‹å¦‚ï¼Œåœ¨ `mybatis-spring-boot-autoconfigure-3.0.3.jar` ä¸­ï¼š
```java
org.mybatis.spring.boot.autoconfigure.MybatisLanguageDriverAutoConfiguration  
org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration
```
# æ ¸å¿ƒä»£ç 
>[!info] com.ryan.sdk.config.DynamicThreadPoolAutoConfig
>è¿™å°±æ˜¯ä¸Šé¢é…ç½®çš„è‡ªåŠ¨è£…é…ç±»ï¼Œè¿™é‡Œ DynamicThreadPollService è¿˜æ²¡æœ‰å®ç°ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•åªæ˜¯ç®€å•çš„è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²
```java
@Slf4j  
@Configuration  
@EnableConfigurationProperties(DynamicThreadPoolAutoProperties.class)  
public class DynamicThreadPoolAutoConfig {  
    @Bean("dynamicThreadPollService")  
    public String dynamicThreadPollService(ApplicationContext applicationContext) {  
        String applicationName = applicationContext.getEnvironment().getProperty("spring.application.name");  
        if (StringUtils.isBlank(applicationName)) {  
            applicationName = "ç¼ºçœçš„";  
            log.warn("åŠ¨æ€çº¿ç¨‹æ± ï¼Œå¯åŠ¨æç¤ºã€‚SpringBoot åº”ç”¨æœªé…ç½® spring.application.name æ— æ³•è·å–åˆ°åº”ç”¨åç§°ï¼");  
        }  
        log.info("åŠ¨æ€çº¿ç¨‹æ± ï¼Œå¯åŠ¨æç¤ºã€‚å½“å‰åº”ç”¨åç§°ï¼š{}", applicationName);  
        Map<String, ThreadPoolExecutor> threadPoolExecutorMap = applicationContext.getBeansOfType(ThreadPoolExecutor.class);  
        // è·å–ç¼“å­˜æ•°æ®ï¼Œè®¾ç½®æœ¬åœ°çº¿ç¨‹æ± é…ç½®  
        Set<String> threadPoolKeys = threadPoolExecutorMap.keySet();  
        for (String threadPoolKey : threadPoolKeys) {  
            ThreadPoolExecutor threadPoolExecutor = threadPoolExecutorMap.get(threadPoolKey);  
            log.info("pool key: {}, core pool size = {}", threadPoolKey, threadPoolExecutor.getCorePoolSize());  
            log.info("pool key: {}, max pool size = {}", threadPoolKey, threadPoolExecutor.getMaximumPoolSize());  
        }  
        return "";  
    }  
}
```
å…·ä½“è·å–ç¨‹åºä¸­æ‰€æœ‰çº¿ç¨‹æ± çš„æ–¹æ³•æ˜¯é€šè¿‡ ApplicationContext æä¾›çš„é€šè¿‡ç±»å‹è·å– Bean çš„æ–¹æ³•
```java
<T> Map<String, T> getBeansOfType(@Nullable Class<T> type) throws BeansException;
```
æˆ‘ä»¬å¼•å…¥è¿™ä¸ªåŒ…ï¼Œç„¶åæ„å»º ThreadPoolExecutor å³å¯ï¼š
>[!info] com.ryan.config.ThreadPoolConfig
> test é¡¹ç›®ä¸­çš„ Config æ–¹æ³•
```java
@Configuration  
@EnableConfigurationProperties(ThreadPoolConfigProperties.class)  
public class ThreadPoolConfig {  
  
    @Bean("threadPoolExecutor01")  
    public ThreadPoolExecutor threadPoolExecutor01(ThreadPoolConfigProperties properties) {  
        // å®ä¾‹åŒ–ç­–ç•¥  
        RejectedExecutionHandler handler;  
        switch (properties.getPolicy()){  
            case "AbortPolicy":  
                handler = new ThreadPoolExecutor.AbortPolicy();  
                break;  
            case "DiscardPolicy":  
                handler = new ThreadPoolExecutor.DiscardPolicy();  
                break;  
            case "DiscardOldestPolicy":  
                handler = new ThreadPoolExecutor.DiscardOldestPolicy();  
                break;  
            case "CallerRunsPolicy":  
                handler = new ThreadPoolExecutor.CallerRunsPolicy();  
                break;  
            default:  
                handler = new ThreadPoolExecutor.AbortPolicy();  
                break;  
        }  
  
        // åˆ›å»ºçº¿ç¨‹æ±   
        return new ThreadPoolExecutor(properties.getCorePoolSize(),  
                properties.getMaxPoolSize(),  
                properties.getKeepAliveTime(),  
                TimeUnit.SECONDS,  
                new LinkedBlockingQueue<>(properties.getBlockQueueSize()),  
                Executors.defaultThreadFactory(),  
                handler);  
    }  
  
    @Bean("threadPoolExecutor02")  
    public ThreadPoolExecutor threadPoolExecutor02(ThreadPoolConfigProperties properties) {  
        // å®ä¾‹åŒ–ç­–ç•¥  
        RejectedExecutionHandler handler;  
        switch (properties.getPolicy()){  
            case "AbortPolicy":  
                handler = new ThreadPoolExecutor.AbortPolicy();  
                break;  
            case "DiscardPolicy":  
                handler = new ThreadPoolExecutor.DiscardPolicy();  
                break;  
            case "DiscardOldestPolicy":  
                handler = new ThreadPoolExecutor.DiscardOldestPolicy();  
                break;  
            case "CallerRunsPolicy":  
                handler = new ThreadPoolExecutor.CallerRunsPolicy();  
                break;  
            default:  
                handler = new ThreadPoolExecutor.AbortPolicy();  
                break;  
        }  
  
        // åˆ›å»ºçº¿ç¨‹æ±   
        return new ThreadPoolExecutor(properties.getCorePoolSize(),  
                properties.getMaxPoolSize(),  
                properties.getKeepAliveTime(),  
                TimeUnit.SECONDS,  
                new LinkedBlockingQueue<>(properties.getBlockQueueSize()),  
                Executors.defaultThreadFactory(),  
                handler);  
    }  
  
}
```
# æµ‹è¯•
ç›´æ¥å¯åŠ¨ test ç¨‹åºï¼Œè§‚å¯Ÿè¾“å‡ºå³å¯ï¼š
```java
2024-10-22T10:35:22.647+08:00  INFO 82454 --- [  restartedMain] c.r.s.c.DynamicThreadPoolAutoConfig      : åŠ¨æ€çº¿ç¨‹æ± ï¼Œå¯åŠ¨æç¤ºã€‚å½“å‰åº”ç”¨åç§°ï¼šdynamic-thread-pool-test-app
2024-10-22T10:35:22.648+08:00  INFO 82454 --- [  restartedMain] c.r.s.c.DynamicThreadPoolAutoConfig      : pool key: threadPoolExecutor01, core pool size = 20
2024-10-22T10:35:22.648+08:00  INFO 82454 --- [  restartedMain] c.r.s.c.DynamicThreadPoolAutoConfig      : pool key: threadPoolExecutor01, max pool size = 50
2024-10-22T10:35:22.648+08:00  INFO 82454 --- [  restartedMain] c.r.s.c.DynamicThreadPoolAutoConfig      : pool key: threadPoolExecutor02, core pool size = 20
2024-10-22T10:35:22.648+08:00  INFO 82454 --- [  restartedMain] c.r.s.c.DynamicThreadPoolAutoConfig      : pool key: threadPoolExecutor02, max pool size = 50
```
