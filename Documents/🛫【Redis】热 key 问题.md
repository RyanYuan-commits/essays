### 1 热 key 背景介绍
在 Redis，热 key 指的那些在极短时间内访问凭此非常高的 key。
热 key 出现的场景：
	节假日或者双十一活动，某个商品促销降价成为爆款；
	新浪微博或者头条某某明星结婚了，大量用户点击浏览这条新闻；
	秒杀活动，瞬间大量爬虫用户或机器人涌入系统。
### 2 热 key 产生的影响
[[🕶️【Redis】缓存穿透]]      [[🦖【Redis】缓存雪崩]]     [[🍫【Redis】缓存击穿]]
对应节点的网卡带宽被打满，出现丢包重传，请求拨动耗时大幅度上升；
请求过多，热点 key 引起 redis 节点数据倾斜，缓存服务被打垮；
大量对请求穿透到 DB，DB 扛不住宕机。
### 3 如何发现热 key
平常我们在设计和开发需求的时候，已经尽可能预判一些热点的场景，但是在真实的环境中还是会有不可预料的场景出现，比如十倍或百倍的突发流量流入。 既然不可能完全避免，我们就需要有一种方法能够在出问题的时候快速定位有没有热key以及是哪些热key，通过这个帮助业务快速定位问题的根源。那究竟如何发现热key呢？ 我们可以从redis请求入手来探测热key，具体如下所示：
#### 3.1 开发独立的热 key 检测系统（推荐）
提供单独的热 key 检测的接入 sdk，应用系统引入该 sdk 以后，热 key 检测系统自动计算是否存在热 key ，并推送相关的结果给应用系统，应用系统根据业务的实际情况进行相应的处理；
#### 3.2 改写 Redis 看客户端收集上报数据
改写 Reids SDK，记录每个请求，定时把收集到的数据上报，然后由一个统一的服务进行聚合计算；方法简单直观，但是无法适应多语言架构，后续对 SDK 的维护升级也需要成本。
#### 3.3 改写 redis 代理层收集上报数据
如果所有的 Redis 请求都经过代理的话，可以考虑给改动 proxy 代码进行收集，思路和客户端基本类似，该方案对使用方完全透明，能够解决客户端 SDK 语言异构和版本升级的问题，但是开发成本相对更高一点；
#### 3.4 利用 redis 新特性定时扫描上报数据
redis 在 4.0 版本之后，提供了 hotkey 查找特性，可以直接利用 redis-cli --hotkeys 的方式获取热点 key；
该方案无需二次开发，但是需要扫描整个 keyspace，实时性比较差，而且耗时和 key 的数量正相关，如果 key 的数量比较多，耗时可能会很长；
#### 3.5 redis 节点抓包解析上报数据
对可能存在热 key 的节点上，通过 tcpdump 抓取一段时间内的流量并且上报，然后有一个外部的程序进行解析、聚合和计算，该方案无需侵入现有的 SDK 或者 Proxy 中间件，开发维护成本可控；
但是也存在一些缺点，因为热 key 的网络流量和系统负载已经很高了，再抓包可能会使情况进一步恶化。
#### 3.6 凭借经验提前预估热 key
### 4 热 key 的解决方案
#### 4.1 使用本地缓存解决
在你发现热 key 以后，把热 key 加载到系统的 JVM 中；针对这种热 key 请求，直接从 jvm 中取，而不会走到 redis 层。
常见的本地缓存可以利用 guava cache 或者 caffeine 实现。 现在假设，你的应用有 100 个节点，OK，你也有 jvm 缓存了。这 10 万个请求平均分散开来，每个节点有 1000 个请求，会从 JVM 中取到值然后返回数据。避免了 10 万个请求打到同一台 redis 上的情形。而如果该 key 是在本地内存中，读取一个内存中的值，每秒多少个万次都是很正常的，不存在任何数据层的瓶颈。
当然，如果通过增加redis集群规模的形式，也能提升数据的访问上限，但问题是事先不知道热 key 在哪里，而全量增加 redis 的规模，性价比很低，毕竟热key不是经常会有。
优点：内存访问和 Reids 访问速度不在一个量级，基于本地缓存，接口性能非常好，可以大大增加单实例的 QPS；
缺点：
	受到应用内存限制，当数据量非常大的时候，占用太多内存，不太适合；
	部分热点数据，需要提前预知；
	热点数据自动检测会有一定的延迟，系统短时间承受的风险比较大。
#### 4.2 分解热 key
通过空间换时间的思想，将一个热key分解为多个不同的小key，分别在redis集群的不同节点进行存储，尽可能降低数据的倾斜；
当瞬间有几十万的请求去访问redis上某个key，通过key分流，请求会分散打到不同的节点获取数据，这样就没有所谓的热点key问题。
#### 4.3 限流熔断
1) 基于 nginx 层限流（集成 lua 限流模块） ；
2) 基于应用网关限流 ；
3) 基于微服务限流常用的限流框架：hystrix 或阿里的 sentinel 常用的限流算法：漏桶、令牌桶、计数器统计、滑动窗口。