### 1 CAP 定理
![[CAP 理论.png|center|600]]
CAP 定理是分布式系统中的一个基本理论，它描述了分布式系统在设计和实现时三种核心属性之间的权衡，CAP 代表以下三个特性：
- **C (Consistency, 一致性)**：所有节点在同一时刻对同一数据的值一致。换句话说，任意客户端读取到的数据都是最新的数据。
- **A (Availability, 可用性)**：每个请求都能在合理的时间内获得响应，不保证返回的值是最新的，但服务必须可用。
- **P (Partition Tolerance, 分区容错性)**：系统能容忍网络分区，即在网络中断或消息丢失的情况下，系统仍能继续工作。
### 2 CAP 定理的核心观点
在分布式系统中，不可能同时完全满足 **一致性 (C)**、**可用性 (A)** 和 **分区容错性 (P)**，必须在三者之间做出权衡。
在单机系统中，无需考虑 P，因此可以保证 CA 同时满足。
而对于分布式而言，P 是必须保证的，否则这就违背了 ”分布式“ 的语义，分布式系统的实现分为两个流派：
1. CP（一致性 + 分区容错性）：强调系统数据的正确性，但由于建立保证不同节点间保证数据严格一致的机制，可能会牺牲系统的可用性; 例如：Zookeeper。
2. AP（可用性 + 分区容错性）：强调系统的可用性，那就必须在数据一致性上做出妥协退让; 例如：Redis、Cassandra。
#### 2.1 一致性问题
**问题一：即时一致性问题**
1. 当前集群的服务端有 master 和 follower 两个节点.
2. 客户端写请求打到了 master，写入 x = 3 这一项内容；
3. 紧接着，客户端读请求打到了 follower，查询 x = 3 的值.
那么在第（3）步中所取得的 x 的值会是多少呢？答案是不确定的. 因为这取决于 master 和 follower 之间数据同步的机制.
倘若，为了满足更快响应客户端的诉求，服务端采用了异步完成数据同步任务的机制，那么客户端的读请求就可能在 follower 同步到 set x = 3 这一项任务之前就打到 follower，此时会取到 x 的老数据或者 x 不存在的响应，总之，读到的数据和客户端期待的结果产生了差距.
以上，就是分布式系统中的即时一致性问题.

**问题二：顺序一致性问题**
1. 客户端依次向 master 发送了 set x = 3、set x = 4 的两笔请求；
2. master 在本机依次完成了两笔写操作，于是状态机中记录的结果为 x = 4；
3. 同时，master 异步开启将请求同步到 follower 的任务，任务发出的顺序也是 ① set x = 3 ② set x = 4；
4. 由于网络问题，第 ① 笔请求出了点状况，导致第 ② 笔请求后发先至，第 ① 笔请求随后而至；
5. 于是 follower 先执行 ② set x = 4，后执行 ① set x = 3，最终 follower 状态机内的结果为 x = 3。
这个问题相比场景（1）就更严重了，因为 follower 中已经记录了错误的数据，接下来不论何时面对客户端的读请求都会返回这个错误的结果. 这种情况下，我们就称分布式系统的最终一致性也遭到了破坏。
#### 2.2 可用性问题
如果要解决一致性的问题，最简单的方式是 “串行化”，master 等待所有 follower 都同步完成再向 Client 返回处理完成的响应；数据同步任务不再是异步执行，而是与写请求串行化执行。
“串行化” 会带来这样的问题：
1. 如果一个 follower 出现宕机，master 无法收到响应，无法响应 ack，会导致整个系统不可用。
2. 如果一个 follower 的同步响应时间过长，会拉低整个系统的响应效率，这就是木桶效应。
### 3 CAP 定理的实际意义
1. 分布式系统中的现实约束：分布式系统几乎无法避免网络分区（如网络延迟、节点宕机），因此 P 是必须满足的。开发者需要在 **一致性 (C)** 和 **可用性 (A)** 之间权衡。
2. 弱一致性模型：很多系统选择弱化一致性，采用 最终一致性（Eventual Consistency）的模型来提高系统的可用性。
### 4 CAP 定理的补充：BASE 理论
由于 CAP 定理的限制，许多分布式系统采用 **BASE 理论**（Basically Available, Soft-state, Eventually consistent）作为设计准则：
- 基本可用（Basically Available）： 系统在故障时允许部分功能不可用，但核心功能仍需保持。
- 软状态（Soft-state）： 系统中的状态可以有一段时间的不一致。
- 最终一致性（Eventually consistent）： 在没有新的更新操作的情况下，系统会在有限时间内最终达到一致状态。
BASE 是 CAP 定理中 **可用性** 和 **一致性** 权衡的典型例子，更适用于大规模分布式系统。