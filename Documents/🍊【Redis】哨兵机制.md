### 1 为什么需要哨兵？
Redis 的主从架构是读写分离的，如果主节点挂了，那么将没有主节点来服务客户端的写操作请求，也没有主节点给从节点进行数据同步了。
![[哨兵 1.png|800]]
此时可以选择人工介入将主从断开，将其中一个从节点变为主节点；Redis 提供了 **哨兵机制** 来自动完成这一过程，当主节点挂掉后会选择一个从节点作为新的主节点，继续服务。
### 2 工作原理
哨兵节点是运行在特殊模式下的 Redis 进程，也作为集群中的节点，主要负责：**监控、选主、通知**
#### 2.1 监控：故障判断
哨兵会每隔一秒向所有的主从节点发送 ping 命令来检测他们是否正常运行，如果主节点或者从节点没有在规定的时间内响应哨兵的 `PING` 命令，哨兵就会将它们标记为「**主观下线**」，时间由配置项 `down-after-milliseconds` 参数设定，单位是毫秒。
为了减少由于网络阻塞原因导致的判断错误，哨兵通常是一个由多个节点组成的 **哨兵集群**，通过多个哨兵节点共同判断主节点是否下线。
当一个哨兵节点标记主节点为「**主观下线**」后，会向其他哨兵节点发起询问命令，哨兵节点根据它与主节点的连接情况给出赞成或不赞成的响应。
![[哨兵投票.png|700]]
当这个哨兵的赞同票数达到哨兵配置文件中的 quorum 配置项设定的值后，这时主节点就会被该哨兵标记为「**客观下线**」。
#### 2.2 选择哨兵 Leader
哨兵 Leader 就是实际负责主从故障转移的哨兵节点，会从判断主节点为「**客观下线**」的哨兵节点中选出，候选者会向其他哨兵发送命令，表明希望成为 Leader 来执行主从切换，并让所有其他哨兵对它进行投票。
那么在投票过程中，任何一个「候选者」，要满足两个条件：
- 第一，拿到半数以上的赞成票；
- 第二，拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值。
#### 2.3 主从故障转移
##### 选出新主节点
首先要过滤掉网络不好的 Redis 节点，Redis 有个叫 `down-after-milliseconds * 10` 配置项；
- `down-after-milliseconds` 是主从节点断连的最大超时时间，如果在超时时间内，主从节点没有连接成功，就可以认为主从节点断连了；
- 如果发生断连的次数超过了 10 次，就说明这个从节点的网络状况不好，不适合作为新主节点。
然后进行三层的过滤筛选：
1. Redis 有个叫 slave-priority 配置项，可以给从节点设置优先级，每一台从节点的服务器配置不一定是相同的，我们可以根据服务器性能配置来设置从节点的优先级，哨兵节点会选出优先级最高的节点作为新主节点；
2. 如果存在多个优先级相同的节点，哨兵节点会选择复制进度最接近主节点的从节点作为新的主节点；
3. 如果复制进度也相同，则 ID 编号小的胜出。
##### 变更主节点
哨兵向选出的主节点发送 `slaveof no one` 命令，让从节点解除 `slave` 身份，变为一个主节点；
随后哨兵每隔十秒钟向从节点发送 `INFO` 命令，并观察回复中的角色信息，如果发现角色信息从 `salve` 变成 `master` 就说明升级成功了。
##### 将从节点指向新主节点
哨兵 Leader 向从节点发送 `slave of` 命令，让从节点变更订阅的主节点。
##### 通知主节点更换
主节点变更信息通过发布订阅机制来实现，每个哨兵节点提供发布者/订阅者机制，客户端可以从哨兵订阅消息。
![[哨兵事件订阅.png|center|600]]
户端和哨兵建立连接后，客户端会订阅哨兵提供的频道。主从切换完成后，哨兵就会向 `+switch-master` 频道发布新主节点的 IP 地址和端口的消息，这个时候客户端就可以收到这条信息，然后用这里面的新主节点的 IP 地址和端口进行通信了。
##### 将旧主节点变为从节点
继续监视旧主节点，当旧主节点重新上线时，哨兵集群就会向它发送 `SLAVEOF` 命令，让它成为新主节点的从节点。