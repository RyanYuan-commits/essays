### 1 数据库瓶颈
当单表数据量过大的时候，会带来数据库的 IO 和 CPU 能力的瓶颈
- 磁盘读取 IO，热点数据过多，数据库缓存放不下，每次查询都需要产生大量的 IO，导致查询的速度低。 ⇒ <font color="#4bacc6">使用分库和垂直分表</font>
- 网络 IO 瓶颈，请求数据太多，一个库撑不住了。 ⇒ <font color="#f79646">分库</font>
- CPU 瓶颈，单表数据量太大，查询时需要扫描内容太多。⇒ <font color="#9bbb59">水平分表</font>
### 2 垂直拆分与水平拆分
一句话来概括，**垂直拆分** 是基于列（字段）的拆分，而 **水平拆分** 是基于行（记录）的拆分。
#### 2.1 垂直拆分
##### 垂直分表
将表按**字段**进行拆分，把不同字段分布到多个表中，每个表中只包含原表的一部分字段，用于 **减少单表的宽度**，优化表的结构和性能。
如果一个表的列非常多，查询特定列时可能会导致大量无关数据的加载，影响查询效率。垂直拆分后，每次查询只需要访问包含所需列的子表，减少了数据的加载量，提高了查询速度。
同时，由于减少了单个表的列数，读取数据时需要从磁盘加载的数据量更小，I/O操作减少，而且对一张表的修改，不再影响另一张表的使用。
##### 垂直分库
![[垂直分库案例.png|700]]
如果我们有两个高频访问的表，课程表 和 订单表，将其拆分到两个库中，分别部署，可以大大减小单机的压力。
#### 2.2 水平拆分
##### 水平分表
将表中的数据**按行拆分**成多个表，常用数据量过大时的分布式存储和扩展，可以把数据分布到不同的数据库或服务器中，常用于解决**单表数据量过大、写入和查询性能瓶颈**的问题。
当表中的记录数非常多时，查询和写入操作会变得缓慢。水平拆分通过将数据按行分散到多个表或数据库中，每个表中的数据量减少，查询和写入压力降低，通过将数据分布到不同的数据库或服务器，系统可以在多台机器上处理查询和写入请求，避免单台服务器成为瓶颈。
水平拆分可以方便地扩展系统的容量。当数据量进一步增加时，只需要增加新的分表或分库，而不需要对现有数据结构做重大调整。
##### 水平分库
如果一个数据库中的数据量过多，会对查询产生影响，此时就可以采用水平分库的方式来将数据放到不同的数据库。
水平拆分的特点是分割的库表结构是完全相同的。
数据存放到哪个库中可以经过哈希算法计算得出。
![[水平分库案例.png|700]]
解决水平分库无法解决的单表数据量过大的问题，拆分成多个相同结构的表。
### 3 分库分表需要解决哪些问题？
分库分表并不只是将表拆开这么简单，在分布式的架构下，我们需要解决诸如下面列出的这些问题
1. **事务的一致性问题**：分库分表将数据分布在不同的服务器，不可避免的带来**分布式事务**的问题。
2. **跨节点关联查询**：分库的时候联合查询可能不在一个数据库，甚至不在一个服务器，无法进行关联查询。
3. **跨节点的分页、排序函数**
4. **主键避重复的问题**，单个表中有自增锁，而分表可能无法保证主键不重复。
在水平拆分的情况下，我们需要需要通过某种方式（如哈希、范围等）来决定将数据存储到哪个表中，查询时也需要根据分片规则进行数据路由。