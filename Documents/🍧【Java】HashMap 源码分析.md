å‰å¯¼çŸ¥è¯†ï¼š[[ğŸœ çº¢é»‘æ ‘]]
### 1 æ•£åˆ—è¡¨ä¸å“ˆå¸Œç®—æ³•
#### 1.1 æ•°ç»„å’Œé“¾è¡¨
![[æ•°ç»„å’Œé“¾è¡¨.png|center|500]]
1. ==æ•°ç»„==ï¼šæ•°ç»„æ˜¯ä¸€ç§ **çº¿æ€§æ•°æ®ç»“æ„**ï¼Œç”±ä¸€ç»„è¿ç»­çš„å†…å­˜å•å…ƒç»„æˆï¼Œæ¯ä¸ªå…ƒç´ éƒ½æœ‰å›ºå®šçš„ **ç´¢å¼•** ä½ç½®ã€‚
   æ•°ç»„çš„ä¼˜ç‚¹æ˜¯ **å¯ä»¥é€šè¿‡ç´¢å¼•å¿«é€Ÿè®¿é—®å…ƒç´ **ï¼Œè®¿é—®å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ã€‚
   ä½†æ˜¯å› ä¸ºæ•°ç»„çš„é•¿åº¦æ˜¯æŒ‡å®šçš„ï¼Œæ‰€ä»¥è¿›è¡Œæ’å…¥å’Œæ‰©å®¹çš„æ“ä½œéå¸¸éº»çƒ¦ï¼Œéœ€è¦å°†åŸæœ¬æ•°ç»„ä¸­çš„å†…å®¹è½¬ç§»åˆ°æ–°æ•°ç»„ä¸­æ‰èƒ½å®Œæˆæ‰©å®¹çš„æ“ä½œã€‚
2. ==é“¾è¡¨==ï¼šé“¾è¡¨ä¹Ÿæ˜¯ä¸€ç§çº¿æ€§æ•°æ®ç»“æ„ï¼Œç”±ä¸€ç³»åˆ—èŠ‚ç‚¹ç»„æˆï¼Œæ¯ä¸ªèŠ‚ç‚¹åŒ…å«ä¸€ä¸ªæ•°æ®å…ƒç´ å’Œä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆã€‚
   é“¾è¡¨çš„ä¼˜ç‚¹æ˜¯ **æ’å…¥å’Œåˆ é™¤æ“ä½œ** å¯ä»¥åœ¨O(1)æ—¶é—´å†…å®Œæˆï¼Œæ— éœ€ç§»åŠ¨å…¶ä»–å…ƒç´ ã€‚
   ç¼ºç‚¹æ˜¯è®¿é—®å…ƒç´ æ—¶éœ€è¦ **éå†æ•´ä¸ªé“¾è¡¨**ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œå¹¶ä¸”ç›¸æ¯”æ•°ç»„å ç”¨æ›´å¤šçš„å†…å­˜ç©ºé—´ã€‚
#### 1.2 æ•£åˆ—è¡¨
![[æ•£åˆ—è¡¨.png|center|500]]
ä¸ä¸Šé¢çš„ä¸¤ç§æ•°æ®ç»“æ„ä¸åŒçš„æ˜¯ï¼Œæ•£åˆ—è¡¨æ˜¯ç”¨æ¥ **å­˜å‚¨é”®å€¼å¯¹** çš„ï¼Œåœ¨å®ç°æ–¹å¼ä¸Šï¼Œæ•£åˆ—è¡¨åƒæ˜¯æ•°ç»„ + é“¾è¡¨çš„ä¸€ä¸ªç»“åˆï¼Œä¹Ÿå°±æ˜¯åŸºæœ¬çš„ç»“æ„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä½†æ•°ç»„ä¸­å­˜å‚¨çš„å…ƒç´ æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼ˆæœ¬æ–‡ä»…è®¨è®ºé“¾åœ°å€æ³•ï¼‰ã€‚
æåˆ°æ•°ç»„ï¼Œæœ€æ˜¾è‘—çš„ç‰¹ç‚¹å°±æ˜¯ç´¢å¼•ï¼Œæ•£åˆ—è¡¨æ˜¯é€šè¿‡ **å“ˆå¸Œç®—æ³•** å°†é”®æ˜ å°„æˆä¸€ä¸ªé•¿åº¦å›ºå®šçš„äºŒè¿›åˆ¶æ•°ï¼Œç„¶åé€šè¿‡ **è·¯ç”±ç®—æ³•** å°†å…¶æ˜ å°„åˆ°æ•°ç»„çš„ç´¢å¼•ä¸­ï¼›å¦‚æœæˆ‘ä»¬åœ¨æƒ³è¦å¯»æ‰¾è¿™ä¸ªè¢«å­˜å‚¨çš„å…ƒç´ ï¼Œåªéœ€è¦é€šè¿‡ç›¸åŒçš„ key -> å“ˆå¸Œç®—æ³• -> è·¯ç”±ç®—æ³• çš„æ–¹å¼ï¼Œå°±å¯ä»¥å¾—åˆ°æ•°ç»„ä¸­çš„ä¸€ä¸ªç´¢å¼•ã€‚
é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œæ•£åˆ—è¡¨æ‹¥æœ‰äº†å’Œé“¾è¡¨ä¸€æ ·å¿«çš„æ’å…¥é€Ÿåº¦ï¼Œä¹Ÿæœ‰äº†å¯ä»¥åª²ç¾æ•°ç»„çš„æŸ¥è¯¢é€Ÿåº¦ï¼Œä½†æ˜¯ä¸€åˆ‡ä½¿ç”¨å“ˆå¸Œç®—æ³•çš„ç»“æ„éƒ½ä¸å¯é¿å…çš„ä¼šé‡åˆ°å“ˆå¸Œå†²çªï¼Œå³ä¸åŒçš„ key ç»è¿‡æ˜ å°„ä¹‹åå¾—åˆ°äº†ç›¸åŒçš„ç»“æœï¼Œéœ€è¦è§£å†³å†²çªçš„æ–¹æ³•ï¼Œé“¾åœ°å€æ³•ã€å¼€æ”¾æ•£åˆ—æ³•ç­‰ï¼›
åœ¨ HashMap ä¸­ä½¿ç”¨çš„æ˜¯ä¼˜åŒ–ä¹‹åçš„é“¾åœ°å€æ³•ï¼Œå³åœ¨æ•°ç»„çš„æŸä¸ªä½ç½®å­˜å‚¨çš„æ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œå¦‚æœé‡åˆ°å“ˆå¸Œå†²çªå°±å°†è¿™äº›å…ƒç´ é“¾æ¥èµ·æ¥ï¼›ä¸ä¼ ç»Ÿçš„é“¾åœ°å€æ³•ä¸åŒçš„æ˜¯ï¼ŒHashMap çš„é“¾åœ°å€æ³•å½“æŸä¸ªä½ç½®é“¾è¡¨è¿‡é•¿çš„æ—¶å€™ï¼Œä¼šå°†è¿™ä¸ªé“¾è¡¨è½¬åŒ–ä¸ºä¸€ä¸ªçº¢é»‘æ ‘ã€‚
#### 1.3 å“ˆå¸Œç®—æ³•
![[å“ˆå¸Œç®—æ³•.png|center|700]]
Hash çš„ä¸­æ–‡é‡Šä¹‰ä¸ºæ•£åˆ—ï¼Œä¸€èˆ¬éŸ³è¯‘ä¸ºå“ˆå¸Œã€‚å“ˆå¸Œç®—æ³•çš„åŠŸèƒ½æ˜¯å°† **ä»»æ„é•¿åº¦** çš„è¾“å…¥ï¼Œé€šè¿‡ç®—æ³•è½¬å˜ä¸ºå›ºå®šé•¿åº¦çš„è¾“å‡ºã€‚
æ˜ å°„çš„è§„åˆ™ç§°ä¸º **å“ˆå¸Œç®—æ³•**ï¼ŒåŸå§‹æ•°æ®é€šè¿‡æ˜ å°„ä¹‹åå¾—åˆ°çš„äºŒè¿›åˆ¶ä¸²å°±æ˜¯ **å“ˆå¸Œå€¼**ã€‚
å“ˆå¸Œç®—æ³•æœ‰å¦‚ä¸‹çš„å‡ ä¸ªç‰¹ç‚¹ï¼š
- æ— æ³•é€šè¿‡å“ˆå¸Œå€¼åæ¨å‡ºåŸå§‹çš„æ•°æ®ï¼Œä¸”æ•°æ®ä¸€ç‚¹å¾®å°çš„å˜åŒ–éƒ½ä¼šå¾—åˆ°å®Œå…¨ä¸åŒçš„å“ˆå¸Œå€¼ï¼Œç›¸åŒçš„æ•°æ®ä¼šå¾—åˆ°å®Œå…¨ç›¸åŒçš„å“ˆå¸Œå€¼ï¼Œè¿™ä¸¤ä¸ªç‰¹ç‚¹ä½¿å¾—å“ˆå¸Œç®—æ³•åœ¨å®‰å…¨æ–¹é¢æœ‰å¹¿æ³›çš„åº”ç”¨ï¼Œæ¯”å¦‚ https çš„æ•°å­—è¯ä¹¦çš„ç­¾åè®¤è¯ã€‚
- å“ˆå¸Œç®—æ³•çš„æ‰§è¡Œæ•ˆç‡å¾ˆé«˜æ•ˆï¼Œé•¿æ–‡æœ¬ä¹Ÿèƒ½å¾ˆå¿«çš„ç®—å‡ºå¯¹åº”çš„å“ˆå¸Œå€¼ã€‚
- ç”±äºæ˜¯å°†ä»»æ„é•¿åº¦æ˜¯è¾“å‡ºæ˜ å°„ä¸ºå›ºå®šé•¿åº¦çš„è¾“å‡ºï¼Œå°†æ— é™ç§æ•°æ®æ˜ å°„ä¸ºæœ‰èŒƒå›´çš„æ•°æ®ï¼Œå¿…ç„¶ä¼šå¯¼è‡´å†²çªï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ **å“ˆå¸Œå†²çª**ã€‚å¦‚ä½•å¤„ç†å“ˆå¸Œå†²çªæ˜¯ä½¿ç”¨å“ˆå¸Œå‡½æ•°çš„æ—¶å€™éœ€è¦è§£å†³çš„é—®é¢˜ã€‚
### 2 HashMap å®ç°æ¦‚è§ˆ
#### 2.1 æ•°æ®ç»“æ„
HashMap æ˜¯åŸºäºÂ **æ•£åˆ—è¡¨**Â å®ç°çš„ï¼Œå…¶åº•å±‚æ˜¯é€šè¿‡æ•°ç»„+é“¾è¡¨ï¼ˆJava8 å¼•å…¥äº†çº¢é»‘æ ‘ï¼‰æ¥å­˜å‚¨æ•°æ®çš„ã€‚
HashMapÂ å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªæ•°ç»„ï¼Œå®ƒæ˜¯ HashMap å®ä¾‹çš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œåä¸º tableï¼Œè¿™ä¸ªæ•°ç»„çš„æ¯ä¸ªä½ç½®ç§°ä¸ºæ¡¶ï¼ˆBucketï¼‰ã€‚ åˆå§‹çš„æ•°ç»„é•¿åº¦å¦‚æœä¸æŒ‡å®šçš„è¯é»˜è®¤ä¸º 16ï¼Œå½“æ’å…¥å…ƒç´ è¿‡å¤šçš„æ—¶å€™ï¼ŒHashMap ä¼šä½¿ç”¨ä¸€ä¸ªæ›´å¤§çš„æ•°ç»„æ›¿æ¢åŸæ¥çš„ tableï¼Œç„¶åå°†åŸæœ¬ table ä¸­çš„å…ƒç´ é‡æ–°æ˜ å°„åˆ°è¿™ä¸ªæ–°çš„æ•°ç»„ã€‚
Java 8 ä¹‹åï¼ŒHashMap ä½¿ç”¨äº†æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘çš„ç»“æ„ï¼Œä»¥åº”å¯¹å“ˆå¸Œå†²çªã€‚æ¯ä¸ªæ¡¶å¯ä»¥å­˜å‚¨ä¸€ä¸ªé“¾è¡¨æˆ–çº¢é»‘æ ‘ã€‚
å½“å“ˆå¸Œå†²çªå‘ç”Ÿæ—¶ï¼Œæ–°çš„é”®å€¼å¯¹ä¼šè¢«æ’å…¥åˆ°å¯¹åº”ä½ç½®çš„é“¾è¡¨æˆ–çº¢é»‘æ ‘ä¸­ï¼Œå…·ä½“æ¥è¯´ï¼Œå½“æŸä¸ªé“¾è¡¨çš„é•¿åº¦è¶…è¿‡ä¸€å®šé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º8ï¼‰ï¼Œä¸” table çš„é•¿åº¦è¶…è¿‡æŸä¸ªé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 64ï¼‰çš„æ—¶å€™ï¼Œè¿™ä¸ªé•¿é“¾è¡¨ä¼šè½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œä»¥æé«˜æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤æ“ä½œçš„æ•ˆç‡ï¼›çº¢é»‘æ ‘æ˜¯ä¸€ç§äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œå®ƒçš„æŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦ä¸º O(log n) ï¼Œé“¾è¡¨åˆ™æ˜¯ O(n)ã€‚
#### 2.2 è·¯ç”±ç®—æ³•
å¤§è‡´è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼šè°ƒç”¨ key çš„ hashCode æ–¹æ³•ï¼Œkey å¯¹è±¡æ˜ å°„ä¸ºä¸€ä¸ª 32 ä½æ•´æ•°ï¼Œä¸ºäº†å°½å¯èƒ½å‡å°‘å“ˆå¸Œå†²çªï¼Œå†å¯¹ hashCode å¾—åˆ°çš„å“ˆå¸Œå€¼è¿›è¡Œä¸€æ¬¡æ‰°åŠ¨ï¼Œä½œä¸ºæœ€ç»ˆçš„å“ˆå¸Œå€¼ã€‚
```java
// æ‰°åŠ¨å‡½æ•°
static final int hash(Object key) {
	 int h;
	 return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}

// è·¯ç”±è®¡ç®—
(table.length - 1) & node.hash
```
#### 2.3 Node èŠ‚ç‚¹
Node å°† value åšä¸€å±‚åŒ…è£…ï¼Œå­˜å‚¨ä¸€äº›å…¶ä»–é‡è¦ä¿¡æ¯ï¼š
```java
/**
 * åŸºæœ¬çš„å“ˆå¸ŒèŠ‚ç‚¹ï¼Œé€‚ç”¨äºå¤§éƒ¨åˆ†çš„å®ä¾‹ï¼ŒHashMap çš„çº¢é»‘æ ‘èŠ‚ç‚¹ TreeNodeã€
 * LinkedHashMap ä¸­çš„èŠ‚ç‚¹ Entry éƒ½æ˜¯åŸºäºè¿™ä¸ª Node å®ç°çš„
 */
static class Node<K,V> implements Map.Entry<K,V> {
	// key çš„ hash
	final int hash;
	// key æœ¬èº«
	final K key;
	// value æœ¬èº«
	V value;
	// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆï¼ˆé“¾è¡¨ï¼‰
	Node<K,V> next;

	Node(int hash, K key, V value, Node<K,V> next) {
		this.hash = hash;
		this.key = key;
		this.value = value;
		this.next = next;
	}
}
```

å½“ Bucket ä¸­å­˜å‚¨çš„æ˜¯é“¾è¡¨çš„æ—¶å€™ï¼Œä½¿ç”¨çš„èŠ‚ç‚¹ç±»æ˜¯ Nodeï¼Œè€Œå½“å­˜å‚¨çš„æ˜¯çº¢é»‘æ ‘çš„æ—¶å€™ï¼Œæ„æˆå…ƒç´ æ˜¯ TreeNodeï¼š
```java
static final class TreeNode<K,V> extends LinkedHashMap.Entry<K,V> {  
    TreeNode<K,V> parent;
    TreeNode<K,V> left;  
    TreeNode<K,V> right;  
    TreeNode<K,V> prev; 
    boolean red;
    
    // ......
}
```
`TreeNode` ä¹Ÿæ˜¯ `HashMap` çš„é™æ€å†…éƒ¨ç±»ï¼Œå®ƒç»§æ‰¿è‡ª `LinkedHashMap.Entry`ï¼Œ`TreeNode` é™¤äº†ä½œä¸ºçº¢é»‘æ ‘çš„èŠ‚ç‚¹ä»¥å¤–ï¼Œè¿˜ä½œä¸ºä¸€ä¸ªåŒå‘çš„é“¾è¡¨èŠ‚ç‚¹ï¼›`TreeNode` åœ¨ `Node` çš„åŸºç¡€ä¸Šæ‹“å±•äº†ä¸çº¢é»‘æ ‘ç›¸å…³çš„å±æ€§ã€‚
### 3 æºç é˜…è¯»
#### 3.1 å…³é”®å¸¸é‡è§£è¯»
åœ¨æ­£å¼é˜…è¯»å…³é”®æºç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»äº†è§£ HashMap ä¸­çš„å…³é”®å¸¸é‡å¼€å§‹ï¼Œè¿™äº›å…³é”®å¸¸é‡å’Œ HashMap çš„åŸºæœ¬ç»“æ„ï¼Œä»¥åŠæ‰©å®¹ã€æ ‘åŒ–ç­‰ç‰¹æ®Šæœºåˆ¶æ¯æ¯ç›¸å…³ï¼ŒæŒæ¡å®ƒä»¬å¯¹äºç†è§£æºç å¾ˆæœ‰å¸®åŠ©ã€‚

```java
static final int DEFAULT_INITIAL_CAPACITY = 1 << 4; // aka 16
```
å¦‚æœåœ¨å®ä¾‹åŒ– HashMap çš„æ—¶å€™æ²¡æœ‰æŒ‡å®šåˆå§‹å®¹é‡ï¼Œå…¶é»˜è®¤å€¼ä¸º 16ã€‚

```java
static final int MAXIMUM_CAPACITY = 1 << 30;
```
è¡¨ç¤º table çš„æœ€å¤§å®¹é‡ï¼Œé™å®šäº†ä¸€ä¸ªæ‰©å®¹çš„ä¸Šé™ï¼Œåœ¨åç»­æ‰©å®¹çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°è¦æ‰©å®¹åˆ°æ¯”ä¸Šé™è¿˜è¦å¤§ï¼Œå°±å°†å®¹é‡å…ˆæ‰©å®¹åˆ°ä¸Šé™ï¼Œå¦‚æœåœ¨å®¹é‡å·²ç»è¾¾åˆ°ä¸Šé™åå†æ¬¡æ‰§è¡Œæ‰©å®¹æ–¹æ³•çš„è¯ï¼Œåˆ™ä¸ä¼šç»§ç»­æ‰©å®¹ã€‚

```java
static final float DEFAULT_LOAD_FACTOR = 0.75f;
```
- HashMap é»˜è®¤çš„è´Ÿè½½å› å­çš„å€¼ï¼Œè´Ÿè½½å› å­ï¼ˆLoad Factorï¼‰æ˜¯æŒ‡å“ˆå¸Œè¡¨ä¸­å·²å­˜å‚¨å…ƒç´ æ•°é‡ä¸å“ˆå¸Œè¡¨å®¹é‡çš„æ¯”ä¾‹ã€‚
- åœ¨å“ˆå¸Œè¡¨ä¸­ï¼Œè´Ÿè½½å› å­ç”¨äºè¡¡é‡å“ˆå¸Œè¡¨çš„å¡«å……ç¨‹åº¦ï¼Œå³å·²å­˜å‚¨å…ƒç´ å å“ˆå¸Œè¡¨å®¹é‡çš„æ¯”ä¾‹ï¼Œå½“å·²å­˜å‚¨å…ƒç´ å æ¯”è¶…è¿‡æŸä¸ªé˜ˆå€¼çš„æ—¶å€™ï¼Œå“ˆå¸Œå†²çªå‘ç”Ÿæ¦‚ç‡ä¼šå¤§å¤§æå‡ï¼Œæ­¤æ—¶å°±éœ€è¦è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œä»¥ç»´æŒä¸€ä¸ªæ¯”è¾ƒå¥åº·çš„çŠ¶æ€ã€‚
- HashMap æ’å…¥å…ƒç´ åä¼šåˆ¤æ–­ table ä¸­çš„å…ƒç´ ä¸ªæ•°æ˜¯å¦å¤§äº `capacity * loadFactor`ï¼Œå¦‚æœæ˜¯ï¼Œå°±ä¼šè§¦å‘æ‰©å®¹æœºåˆ¶ã€‚å¸¸ç”¨çš„è´Ÿè½½å› å­å€¼ä¸º 0.75ï¼Œè¿™æ˜¯ä¸€ä¸ªç»éªŒå€¼ï¼Œå¯ä»¥åœ¨å¹³è¡¡å†…å­˜å ç”¨å’Œæ€§èƒ½ä¹‹é—´åšå‡ºæƒè¡¡ï¼Œéå¿…è¦ä¸éœ€è¦è‡ªå·±é¢å¤–æŒ‡å®šã€‚

```java
static final int TREEIFY_THRESHOLD = 8;

static final int UNTREEIFY_THRESHOLD = 6;

static final int MIN_TREEIFY_CAPACITY = 64;
```
- ä¸Šé¢çš„ä¸‰ä¸ªå¸¸é‡éƒ½å’Œ HashMap çš„æ ‘åŒ–æœºåˆ¶æœ‰å…³ï¼Œ`TREEIFY_THRESHOLD` å’Œ `MIN_TREEIFY_CAPACITY` å†³å®šäº†é“¾è¡¨æ ‘åŒ–çš„æ—¶é—´ï¼Œå…·ä½“æ¥è¯´ï¼Œå½“ä¸€ä¸ªé“¾è¡¨çš„é•¿åº¦è¾¾åˆ° 8 ä¸”æ­¤æ—¶ table æ•°ç»„çš„é•¿åº¦è¾¾åˆ° 64ï¼Œè¿™ä¸ªé“¾è¡¨ä¼šè½¬åŒ–ä¸ºçº¢é»‘æ ‘ç»“æ„ï¼›
- ä¹‹æ‰€ä»¥ä¹Ÿè¦å¯¹ table çš„é•¿åº¦åšé™å®šï¼Œæ˜¯å› ä¸ºå½“ table é•¿åº¦è¿‡å°çš„æ—¶å€™ï¼Œå‘ç”Ÿå“ˆå¸Œå†²çªçš„æ¦‚ç‡å¾ˆå¤§ï¼Œé“¾è¡¨é•¿åº¦ä¼šå¾ˆå®¹æ˜“è¾¾åˆ°é˜ˆå€¼ï¼Œè¿™æ—¶å€™æ‰§è¡Œæ ‘åŒ–æ“ä½œæ€§ä»·æ¯”è¾ƒä½ï¼Œé¢‘ç¹æ ‘åŒ–æ“ä½œä¼šå½±å“æ€§èƒ½ã€‚
- `UNTREEIFY_THRESHOLD` æ˜¯æ ‘é™çº§ä¸ºé“¾è¡¨çš„é˜ˆå€¼ï¼Œå½“æ ‘ä¸­çš„å…ƒç´ é™ä½åˆ° 6 ä¸ªåï¼Œå°†æ ‘é™çº§ä¸ºé“¾è¡¨ã€‚
#### 3.2 å…³é”®å±æ€§è§£è¯»
```java
transient Node<K,V>[] table;
```
HashMap åº•å±‚ä¸­å®é™…å­˜å‚¨æ•°æ®çš„å®¹å™¨ï¼Œæ˜¯ä¸€ä¸ª Node æ•°ç»„ï¼›table è¢« transient å…³é”®å­—ä¿®é¥°ï¼Œåœ¨ HashMap å®ä¾‹å¯¹è±¡åºåˆ—åŒ–çš„æ—¶å€™ table ä¸ä¼šå‚ä¸åºåˆ—åŒ–ï¼Œå› ä¸º table é™¤äº†å­˜å‚¨ k-v ä¹‹å¤–ï¼Œè¿˜ç»´æŠ¤äº†é“¾è¡¨ã€çº¢é»‘æ ‘çš„ç»“æ„ï¼Œè¿™äº›ç»“æ„æ€§çš„å†…å®¹ä¼ è¾“è¿‡å»å¹¶æ²¡æœ‰ä»€ä¹ˆä½œç”¨ï¼›
HashMap æä¾›äº† writeObject å’Œ readObject æ–¹æ³•æ¥è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œä¼ è¾“è¿‡ç¨‹ä¸­åªéœ€è¦ä¼ è¾“é”®å€¼å¯¹ï¼Œè€Œä¸æ˜¯æ•´ä¸ª tableã€‚

```java
transient int size;
```
å½“å‰ Map ä¸­å­˜å‚¨çš„ K-V é”®å€¼å¯¹çš„æ•°é‡ã€‚

```java
int threshold;
```
æ‰©å®¹é˜ˆå€¼ï¼Œå…·ä½“å€¼ä¸º capacity * loadFactorï¼Œå½“ Map ä¸­çš„å…ƒç´ ä¸ªæ•°è¾¾åˆ° threshold å°±ä¼šè§¦å‘æ‰©å®¹ã€‚

```java
final float loadFactor;
```
è´Ÿè½½å› å­çš„å€¼ï¼Œå¯ä»¥é€šè¿‡ HashMap(int initialCapacity, float loadFactor) æ„é€ æ–¹æ³•æŒ‡å®šã€‚

#### 3.3 æ„é€ æ–¹æ³•
##### 3.3.1 æŒ‡å®šå®¹é‡å’Œè´Ÿè½½å› å­
```java
    public HashMap(int initialCapacity, float loadFactor) {
        if (initialCapacity < 0)
            throw new IllegalArgumentException("Illegal initial capacity: " + initialCapacity);
        if (initialCapacity > MAXIMUM_CAPACITY)
            initialCapacity = MAXIMUM_CAPACITY;
        if (loadFactor <= 0 || Float.isNaN(loadFactor))
            throw new IllegalArgumentException("Illegal load factor: " + loadFactor);
        this.loadFactor = loadFactor;
        this.threshold = tableSizeFor(initialCapacity);
    }
```
- å½“å‘ç°åˆå§‹å®¹é‡å¤§äºå®¹é‡ä¸Šé™æ—¶ï¼Œä¼šå…ˆå°† initialCapacity è®¾ä¸º MAXIMUM_CAPACITYã€‚
- è°ƒç”¨ `tableSizeFor` æ–¹æ³•ç”¨äºè®¡ç®— table æœ€ç»ˆå®¹é‡ï¼Œå› ä¸º HashMap çš„æ•°ç»„å®¹é‡ä¸€å®šæ˜¯ 2 çš„å¹‚ï¼Œç„¶åå°†ç»“æœèµ‹å€¼ç»™ `this.threshold`ï¼Œå½“åˆ›å»º table æ•°ç»„çš„æ—¶å€™ï¼Œä¼šå°† threshold ä½œä¸ºå®¹é‡ã€‚
##### 3.3.2 æŒ‡å®šåˆå§‹å®¹é‡
```java
public HashMap(int initialCapacity) {
	this(initialCapacity, DEFAULT_LOAD_FACTOR);
}
```
æŒ‡å®šåˆå§‹å®¹é‡çš„æ„é€ æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨äº†å‰é¢çš„ HashMap(int initialCapacity, float loadFactor) æ–¹æ³•ã€‚ 
##### 3.3.3 ç©ºå‚æ„é€ 
```java
public HashMap() {
	this.loadFactor = DEFAULT_LOAD_FACTOR;
}
```
- ä¸ºè´Ÿè½½å› å­èµ‹é»˜è®¤å€¼ `DEFAULT_LOAD_FACTOR`
- æ–¹æ³•ä¸­æ²¡æœ‰æŒ‡å®š threshold å€¼ï¼ŒHashMap å°† threshold ä¸ºé›¶ä½œä¸ºç”¨æˆ·æœªæŒ‡å®šåˆå§‹å®¹é‡çš„æ ‡è¯†ï¼Œåœ¨åˆ›å»º table çš„æ—¶å€™ï¼Œå¦‚æœå‘ç° threshold ä¸º 0ï¼Œå°±ä¼šå°† table çš„å®¹é‡è®¾ç½®ä¸ºé»˜è®¤å€¼ 16ã€‚
##### 3.3.4 åŸºäºå…¶ä»– Map æ„é€ 
```java
public HashMap(Map<? extends K, ? extends V> m) {
	this.loadFactor = DEFAULT_LOAD_FACTOR;
	putMapEntries(m, false);
}
```
è°ƒç”¨äº† putMapEntries æ–¹æ³•ï¼Œå°†ä¼ å…¥ Map ä¸­çš„æ•°æ®æ’å…¥åˆ°æœ¬ HashMap ä¸­ï¼š
```java
final void putMapEntries(Map<? extends K, ? extends V> m, boolean evict) {  
    int s = m.size();  
    if (s > 0) {  
        if (table == null) { // pre-size  
            float ft = ((float)s / loadFactor) + 1.0F;  
            int t = ((ft < (float)MAXIMUM_CAPACITY) ? (int)ft : MAXIMUM_CAPACITY);  
            if (t > threshold)  threshold = tableSizeFor(t);  
        }  
        else if (s > threshold) resize();  
        
        for (Map.Entry<? extends K, ? extends V> e : m.entrySet()) {  
            K key = e.getKey();  
            V value = e.getValue();  
            putVal(hash(key), key, value, false, evict);  
        }  
    }  
}
```
- è®¡ç®—ä¸€ä¸ªåˆç†çš„å®¹é‡ï¼Œå°†å…¶ä¿å­˜åˆ° threshold ä¸­ï¼›
- è€Œå½“ table ä¸ä¸º null çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°éœ€è¦æ’å…¥çš„å…ƒç´ ä¸ªæ•°å·²ç»è¾¾åˆ°çš„è‡ªå·±çš„æ‰©å®¹é˜ˆå€¼ï¼Œé¢„å…ˆè¿›è¡Œä¸€æ¬¡æ‰©å®¹ï¼›
- éå†ä¼ å…¥çš„ Mapï¼Œè°ƒç”¨ putVal æ–¹æ³•å°† K-V é”®å€¼å¯¹ä¸€ä¸ªä¸€ä¸ªæ’å…¥ã€‚

---

é€šè¿‡ä¸Šé¢çš„å››ä¸ªæ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºè¿™ä¹ˆä¸¤ä¸ªç»“è®ºï¼š
- HashMap ä¸ºäº†ä¼˜åŒ–å†…å­˜ï¼Œå°† table çš„åˆå§‹åŒ–æ—¶æœºè®¾è®¡åˆ°é¦–æ¬¡æ’å…¥å…ƒç´ åï¼›
- ä½¿ç”¨ HashMap#tableSizeFor æ–¹æ³•ä¿è¯äº† table çš„å®¹é‡ä¸€å®šæ˜¯ 2 çš„å¹‚æ¬¡ã€‚

#### 3.4 putVal æ–¹æ³•
å½“æˆ‘ä»¬æƒ³è¦å‘ HashMap ä¸­æ’å…¥å…ƒç´ çš„ï¼Œä¼šè°ƒç”¨ put æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åº•å±‚è°ƒç”¨çš„æ˜¯ putVal æ–¹æ³•ï¼š
```java
 public V put(K key, V value) {
	 return putVal(hash(key), key, value, false, true);
}

static final int hash(Object key) {
	 int h;
	 return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```
åœ¨è°ƒç”¨ putVal ä¹‹å‰ï¼Œä¼šè°ƒç”¨ hash æ–¹æ³•è®¡ç®— key çš„å“ˆå¸Œå€¼ï¼š
- å¦‚æœä¼ å…¥çš„ key æ˜¯ nullï¼Œé‚£å°±ç›´æ¥æ˜ å°„ä¸º 0ï¼Œä»è¿™é‡Œå¯ä»¥çœ‹å‡º ==HashMap æ˜¯å¯ä»¥ä½¿ç”¨ null ä½œä¸º key çš„==ï¼›
- å¦‚æœ key ä¸ä¸º nullï¼Œæ‰§è¡Œ hashCode æ–¹æ³•è·å¾—å“ˆå¸Œå€¼ï¼Œç„¶åå°†è¿™ä¸ªå€¼ä¸å…¶å³ç§» 16 ä½çš„å€¼åšæŒ‰ä½å¼‚æˆ–è¿ç®—ã€‚

>[!question] ä¸ºä»€ä¹ˆä¸ç›´æ¥é‡‡ç”¨åŸå§‹çš„å“ˆå¸Œå€¼å‘¢ï¼Ÿ
> HashMap çš„è·¯ç”±ç®—æ³•æ˜¯è¿™æ ·çš„ï¼š`(table.length - 1) & node.hashï¼›`ï¼Œæ•°ç»„çš„é•¿åº¦è¶Šå°ï¼Œkey èµ·ä½œç”¨çš„å“ˆå¸Œå€¼çš„ä½æ•°å°±è¶Šå°‘ï¼Œä¸åŒ key ä¹‹é—´çš„åŒºåˆ†åº¦å°±æ¯”è¾ƒä½ï¼Œä¹Ÿå°±å®¹æ˜“å‡ºç°å“ˆå¸Œå†²çªï¼›
> ä¸ºäº†è®©ä¸åŒå…ƒç´ å“ˆå¸Œå€¼çš„åˆ†å¸ƒå°½é‡åˆ†æ•£ï¼Œå¯ä»¥è®©é«˜ä½çš„å€¼ä¹Ÿå‚ä¸è¿›æ¥ï¼Œè¿™ç§æ“ä½œå¾ˆå½¢è±¡çš„è¢«ç§°ä¸º â€œæ‰°åŠ¨â€ï¼Œå…·ä½“çš„å®ç°æ–¹å¼è¢«ç§°ä¸º â€æ‰°åŠ¨å‡½æ•°â€œã€‚

```java
 final V putVal(int hash, K key, V value, boolean onlyIfAbsent, boolean evict) {
	 // åº•å±‚ table
	 Node<K,V>[] tab; 
	 // i ä½ç½®æ­¤æ—¶çš„å…ƒç´ ï¼Œnull è¡¨ç¤ºæ²¡æœ‰å…ƒç´ 
	 Node<K,V> p;
	 // i: node èŠ‚ç‚¹æ’å…¥çš„ä½ç½®
	 // n: table æ•°ç»„çš„é•¿åº¦
	 int n, i;
	 if ((tab = table) == null || (n = tab.length) == 0) n = (tab = resize()).length;
	 
	 if ((p = tab[i = (n - 1) & hash]) == null) tab[i] = newNode(hash, key, value, null);
	 else { 
		// æ’å…¥ä½ç½®æœ‰å…ƒç´ 
	 }
	 // è¢«ä¿®æ”¹çš„æ¬¡æ•°
	 ++modCount;
	 // size è¾¾åˆ°æ‰©å®¹é˜ˆå€¼ï¼Œæ‰©å®¹
	 if (++size > threshold) resize();
	 afterNodeInsertion(evict);
	 return null;
 }
```
- å…ˆåˆ¤æ–­ table æ•°ç»„æ˜¯å¦è¢«åˆ›å»ºï¼ˆ`table == null || tab.length == 0` ï¼‰ï¼Œå¦‚æœè¿˜æ²¡æœ‰ï¼Œæ‰§è¡Œ resize æ–¹æ³•æ¥åˆ›å»º tableï¼Œ==HashMap å°† table çš„åˆ›å»ºå»¶ååˆ°ç¬¬ä¸€æ¬¡æ’å…¥å…ƒç´ æ—¶==ã€‚
- ç„¶ååˆ¤æ–­æ’å…¥ä½ç½®æ˜¯å¦æœ‰å…ƒç´ ï¼ˆ`tab[(n - 1) & hash] == null`ï¼‰ï¼Œè‹¥ä¸º null åˆ™ç›´æ¥å°†æ–°èŠ‚ç‚¹æ’å…¥ã€‚
- å½“æ’å…¥ä½ç½®æœ‰å…ƒç´ çš„æ—¶å€™å¤„ç†æ–¹å¼æ˜¯è¿™æ ·çš„ï¼š
```java
else {
	// å¦‚æœæ’å…¥çš„ key å­˜åœ¨äº table ä¸­ï¼Œe è¡¨ç¤ºè¯¥ Nodeï¼Œå¦åˆ™ï¼Œe ä¸º null
	Node<K,V> e;
	// æš‚å­˜æ’å…¥ä½ç½®å…ƒç´ çš„ key å€¼
	K k;
	// æ’å…¥ä½ç½®çš„ Bucket ä¸­é¦–ä¸ªå…ƒç´ çš„ key å’Œ Node çš„ key ç›¸åŒ
	if (p.hash == hash && ((k = p.key) == key || (key != null && key.equals(k)))) e = p;
	
	// æ’å…¥ä½ç½®çš„ Bucket ä¸­å­˜å‚¨çš„æ˜¯çº¢é»‘æ ‘
	else if (p instanceof TreeNode) e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);
	
	// æ’å…¥ä½ç½®çš„ Bucket ä¸­å­˜å‚¨çš„æ˜¯é“¾è¡¨
	else { 
		for (int binCount = 0; ; ++binCount) {
			if ((e = p.next) == null) { // éå†è¿‡ç¨‹ä¸­æ²¡æœ‰æ‰¾åˆ°ä¸æ’å…¥èŠ‚ç‚¹ key ç›¸åŒçš„æƒ…å†µ
				p.next = newNode(hash, key, value, null);
				if (binCount >= TREEIFY_THRESHOLD - 1) treeifyBin(tab, hash);
				break;
			}
			 // éå†èŠ‚ç‚¹çš„æ—¶å€™æ‰¾åˆ°äº†ä¸æ’å…¥èŠ‚ç‚¹ key ç›¸åŒçš„èŠ‚ç‚¹
			if (e.hash == hash && ((k = e.key) == key || (key != null && key.equals(k)))) break;
			p = e;
		}
	}
	// é’ˆå¯¹æ›¿æ¢æ“ä½œçš„é€»è¾‘
	if (e != null) { 
		V oldValue = e.value;
		if (!onlyIfAbsent || oldValue == null)
			e.value = value;
		afterNodeAccess(e);
		return oldValue;
	}
}
```
- éå† Bucket ä¸­å­˜å‚¨çš„å…ƒç´ ï¼Œå¦‚æœ key å·²å­˜åœ¨ï¼Œä½¿ç”¨å˜é‡ e æ¥æš‚å­˜è¿™ä¸ª Node çš„å¼•ç”¨ï¼Œåç»­æ‰§è¡Œæ›¿æ¢æ“ä½œï¼›
- å¦‚æœæ­¤æ—¶ Bucket ä¸­å­˜å‚¨çš„æ˜¯ä¸€ä¸ªçº¢é»‘æ ‘ï¼Œè°ƒç”¨ putTreeVal æ–¹æ³•æ¥å¤„ç†ã€‚
- å¦‚æœ key æ˜¯ç¬¬ä¸€æ¬¡å‡ºç°ï¼Œä¹Ÿå°±æ˜¯åœ¨æ‰«æ Bucket çš„æ—¶å€™å‘ç° `p.next == null`ï¼Œç›´æ¥å°†æ–°çš„ Node ç½®äºé“¾è¡¨ç»“å°¾ã€‚

å½“æ’å…¥ key ä¹‹åï¼Œä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ‰§è¡Œæ ‘åŒ–ï¼š
```java
final void treeifyBin(Node<K,V>[] tab, int hash) {  
    int n, index; Node<K,V> e;  
    if (tab == null || (n = tab.length) < MIN_TREEIFY_CAPACITY)  
        resize();
    else if ((e = tab[index = (n - 1) & hash]) != null) {  
		// æ ‘åŒ–
    }  
}
```
#### 3.5 resize æ–¹æ³•
resize å¯ä»¥åœ¨ table æœªåˆ›å»ºçš„æ—¶å€™è¢«è°ƒç”¨ï¼Œç”¨æ¥åˆ›å»º tableï¼Œä¹Ÿå¯ä»¥å¯¹å·²åˆ›å»ºçš„ table è¿›è¡Œæ‰©å®¹ï¼Œæ–¹æ³•æ€»ä½“å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯ç¡®å®šæ–°çš„å®¹é‡å’Œæ–°çš„æ‰©å®¹é˜ˆå€¼ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯æ‰§è¡Œå®é™…çš„æ‰©å®¹æ“ä½œï¼š
##### 3.5.1 ç¡®å®šæ–°çš„å®¹é‡å’Œæ‰©å®¹é˜ˆå€¼
```java
final Node<K,V>[] resize() {
	// ç¬¬ä¸€éƒ¨åˆ†ï¼šç¡®å®š newCap å’Œ newThr çš„å€¼
	Node<K,V>[] oldTab = table;
	int oldCap = (oldTab == null) ? 0 : oldTab.length;
	int oldThr = threshold;
	int newCap, newThr = 0;
	
	// å¦‚æœ table å·²ç»è¢«åˆ›å»º
	if (oldCap > 0) {
		if (oldCap >= MAXIMUM_CAPACITY) {
			threshold = Integer.MAX_VALUE;
			return oldTab;
		}
		// å°†å®¹é‡æ‰©å®¹ä¸ºåŸæ¥çš„äºŒå€
		else if ((newCap = oldCap << 1) < MAXIMUM_CAPACITY && oldCap >= DEFAULT_INITIAL_CAPACITY) newThr = oldThr << 1;
	}
	// åˆå§‹å®¹é‡å­˜å‚¨åœ¨ threshold ä¸­
	else if (oldThr > 0) newCap = oldThr;
	// threshold æ ‡è¯†ç€ä½¿ç”¨é»˜è®¤çš„å®¹é‡
	else {               
		newCap = DEFAULT_INITIAL_CAPACITY;
		newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);
	}
	if (newThr == 0) {
		float ft = (float) newCap * loadFactor;
		newThr = (newCap < MAXIMUM_CAPACITY && ft < (float)MAXIMUM_CAPACITY ? (int)ft : Integer.MAX_VALUE);
	}
	threshold = newThr;
	
	// ......
}
```
æ ‡å‡†æƒ…å†µä¸‹ï¼Œæ‰§è¡Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š
- å¦‚æœ table å·²ç»è¢«åˆ›å»ºï¼ˆ`oldCap > 0`ï¼‰ï¼Œæ­¤æ—¶æ‰§è¡Œçš„æ˜¯æ‰©å®¹ï¼š
	- åˆ¤æ–­å®¹é‡æ˜¯å¦è¶…è¿‡æ‰©å®¹ä¸Šé™ `MAXIMUM_CAPACITY`ï¼Œå¦‚æœæ˜¯å°±ç›´æ¥è¿”å›ï¼›
	- è®¡ç®— `oldCap << 1` çš„å€¼ï¼Œå°†å…¶èµ‹å€¼ç»™ newCapï¼ŒåŒæ—¶å°† oldThr å·¦ç§»ä¸€ä½ï¼Œèµ‹å€¼ç»™ newThrã€‚
- å½“ table çš„æœªè¢«åˆ›å»ºæ—¶ï¼š
	- å¦‚æœ oldThr ä¸ä¸º 0ï¼Œè¡¨æ˜ç”¨æˆ·æŒ‡å®šäº†åˆå§‹å®¹é‡ï¼Œå°†å…¶èµ‹å€¼ç»™ newCapï¼Œå¦åˆ™ï¼Œä½¿ç”¨é»˜è®¤å®¹é‡
	- ä½¿ç”¨é»˜è®¤çš„è´Ÿè½½å› å­è®¡ç®—å‡ºæ‰©å®¹é˜ˆå€¼ï¼Œèµ‹å€¼ç»™ newThrã€‚
##### 3.5.2 åˆ›å»ºæ–° table å¹¶è¿ç§»
```java
// ç¬¬äºŒéƒ¨åˆ†ï¼šå°†åŸæ•°ç»„ä¸­å†…å®¹å¤åˆ¶åˆ°æ‹“å±•åçš„æ–°æ•°ç»„ä¸­
@SuppressWarnings({"rawtypes","unchecked"})
Node<K,V>[] newTab = (Node<K,V>[])new Node[newCap];
table = newTab;
if (oldTab != null) {
	for (int j = 0; j < oldCap; ++j) { // éå†åŸæœ¬çš„æ•°ç»„
		Node<K,V> e;
		if ((e = oldTab[j]) != null) {
			oldTab[j] = null;
			// ä»…æœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„æƒ…å†µ
			if (e.next == null) newTab[e.hash & (newCap - 1)] = e;
			 // æ˜¯æ ‘èŠ‚ç‚¹çš„æƒ…å†µ
			else if (e instanceof TreeNode)((TreeNode<K,V>)e).split(this, newTab, j, oldCap);
			else { 
				// å¯¹é“¾è¡¨è¿ç§»çš„ä¼˜åŒ–
			}
		}
	}
}
return newTab;
```
- é¦–å…ˆæ ¹æ®ä¸Šé¢è®¡ç®—å‡ºæ¥çš„æ–°çš„å®¹é‡ï¼Œåˆ›å»ºæ–°çš„ table æ•°ç»„ï¼›
- ç„¶åå¦‚æœè€ table ä¸ä¸º nullï¼Œå°±éœ€è¦æ‰§è¡Œå¤åˆ¶è½¬ç§»çš„æ“ä½œï¼Œä½¿ç”¨ä¸€ä¸ª for å¾ªç¯æ¥éå†è€ table çš„æ‰€æœ‰ä½ç½®å¹¶æ‰§è¡Œè¿ç§»ï¼›
##### 3.5.3 å¯¹é“¾è¡¨è¿ç§»çš„ä¼˜åŒ–
å¯¹äºé“¾è¡¨èŠ‚ç‚¹ï¼ŒHashMap åœ¨è¿ç§»çš„æ—¶å€™è¿›è¡Œäº†ä¼˜åŒ–ï¼š
```java
Node<K,V> loHead = null, loTail = null;
Node<K,V> hiHead = null, hiTail = null;
Node<K,V> next;
do {
	next = e.next;
	if ((e.hash & oldCap) == 0) {
		if (loTail == null) loHead = e;
		else loTail.next = e;
		loTail = e;
	}
	else {
		if (hiTail == null) hiHead = e;
		else hiTail.next = e;
		hiTail = e;
	}
} while ((e = next) != null);
if (loTail != null) {
	loTail.next = null;
	newTab[j] = loHead;
}
if (hiTail != null) {
	hiTail.next = null;
	newTab[j + oldCap] = hiHead;
}
```
è¿™äº›èŠ‚ç‚¹å¤„äºç›¸åŒçš„ Bucketï¼Œä¹Ÿå°±è¡¨æ˜å®ƒä»¬ `node.hash & oldTab.length - 1`  çš„ç»“æœç›¸åŒï¼›

è¿™äº›èŠ‚ç‚¹åœ¨æ–°çš„é“¾è¡¨ä¸­çš„ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯ `hash & oldTab.length*2 - 1` çš„å€¼æ˜¯æœ‰è¿¹å¯å¾ªçš„ï¼š
![[HashMap æ‰©å®¹ä¼˜åŒ–.png|500]]
- ä»¥ 16 æ‹“å±•åˆ° 32 ä¸ºä¾‹ï¼Œåˆ¨å»ç›¸åŒçš„éƒ¨åˆ†ï¼Œå“ˆå¸Œçš„å‰ç¼€è¦ä¹ˆæ˜¯ 1 è¦ä¹ˆæ˜¯ 0
- å¦‚æœå‰ç¼€ä¸º 1ï¼Œä¸ 32 - 1 åšæŒ‰ä½ä¸ä¹‹åï¼Œå¾—åˆ°çš„ç»“æœå°±æ˜¯åŸæœ¬çš„ä½ç½®åŠ ä¸Šä¸€ä¸ª 16ï¼Œä¹Ÿå°±æ˜¯ oldTab.length
- è€Œå¯¹äºå‰ç¼€ä¸º 0 çš„å…ƒç´ ï¼Œä½ç½®åˆ™ä¸ä¼šæ”¹å˜ï¼›
å°†ä½äºåŸæœ¬ä½ç½® + oldTab.length çš„å…ƒç´ ç§°ä¸ºé«˜ä½å…ƒç´ ï¼Œå°†ä»å¤„äºåŸæœ¬ä½ç½®çš„å‘½åä¸ºä½ä½å…ƒç´ ï¼›ç”±æ­¤å¼•å‡ºäº†ä¸‹é¢çš„å››ç§å˜é‡ï¼š
```java
Node<K,V> loHead = null, loTail = null; // éœ€è¦æ”¾ç½®åœ¨æ–° table ä½ä½èŠ‚ç‚¹çš„å¤´éƒ¨å’Œå°¾éƒ¨
Node<K,V> hiHead = null, hiTail = null; // éœ€è¦æ”¾ç½®åœ¨æ–° table é«˜ä½çš„èŠ‚ç‚¹çš„å¤´éƒ¨å’Œå°¾éƒ¨
```
åœ¨è¿ç§»çš„æ—¶å€™ï¼Œæ„é€ å‡ºä½ä½å’Œé«˜ä½ä¸¤ä¸ªé“¾è¡¨ï¼Œå†å­˜å…¥æ–° table çš„ Bucket ä¸­ï¼Œå¤§å¤§ä¼˜åŒ–äº†è¿ç§»çš„æ•ˆç‡ã€‚
### 4 HashMap çš„çº¿ç¨‹å®‰å…¨é—®é¢˜
##### 4.1 å¤šçº¿ç¨‹ put å¯¼è‡´çš„å…ƒç´ ä¸¢å¤±é—®é¢˜
å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶å‘ HashMap ä¸­æ·»åŠ å…ƒç´ ï¼Œä¼šå¯¼è‡´å…ƒç´ ä¸¢å¤±çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ ¹æ®æºç æ¥åˆ†æä¸€ä¸‹ï¼š
```java
else { 
	for (int binCount = 0; ; ++binCount) {
		if ((e = p.next) == null) { // éå†è¿‡ç¨‹ä¸­æ²¡æœ‰æ‰¾åˆ°ä¸æ’å…¥èŠ‚ç‚¹ key ç›¸åŒçš„æƒ…å†µ
			p.next = newNode(hash, key, value, null);
			if (binCount >= TREEIFY_THRESHOLD - 1) treeifyBin(tab, hash);
			break;
		}
		 // éå†èŠ‚ç‚¹çš„æ—¶å€™æ‰¾åˆ°äº†ä¸æ’å…¥èŠ‚ç‚¹ key ç›¸åŒçš„èŠ‚ç‚¹
		if (e.hash == hash && ((k = e.key) == key || (key != null && key.equals(k)))) break;
		p = e;
	}
}
if (e != null) { // é’ˆå¯¹æ›¿æ¢æ“ä½œçš„é€»è¾‘
	V oldValue = e.value;
	if (!onlyIfAbsent || oldValue == null)
		e.value = value;
	afterNodeAccess(e);
	return oldValue;
}
```
ä¸Šé¢æˆªå–çš„æ˜¯ HashMap æ’å…¥çš„æ—¶å€™å¦‚æœæ’å…¥çš„ä½ç½®æœ‰å…ƒç´ çš„æƒ…å†µï¼›
æˆ‘ä»¬å‡è®¾æ­¤æ—¶è¿™ä¸ªä½ç½®æœ‰ä¸€ä¸ªå…ƒç´  k1ï¼š
![[çº¿ç¨‹ put å¯¼è‡´çš„å…ƒç´ ä¸¢å¤±é—®é¢˜1.png|100]]
æ­¤æ—¶ä¸€ä¸ªçº¿ç¨‹æ’å…¥ k2ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æ’å…¥ k3ï¼›å‡è®¾ä¸¤ä¸ªçº¿ç¨‹éƒ½åˆ¤æ–­ if ((e = p.next) == null) ä¸º trueï¼Œè¿›å…¥åˆ°è¿™ä¸ªä»£ç æ®µï¼š
```java
p.next = newNode(hash, key, value, null);
if (binCount >= TREEIFY_THRESHOLD - 1) treeifyBin(tab, hash);
break;
```
æ­¤æ—¶çº¿ç¨‹ 1 æ’å…¥äº† k2ï¼Œç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤º
![[å¤šçº¿ç¨‹ put å¯¼è‡´çš„å…ƒç´ ä¸¢å¤±é—®é¢˜ 2.png|300]]
ä½†æ˜¯çº¿ç¨‹ 2 ä»ç„¶ä¼šæ‰§è¡Œ `p.next = newNode(hash, key, value, null);`ï¼Œæ­¤æ—¶ k2 å°±ä¸¢å¤±äº†ï¼Œè¿™å°±æ˜¯å¤šçº¿ç¨‹ put å¯¼è‡´çš„å…ƒç´ ä¸¢å¤±é—®é¢˜ã€‚
##### 4.2 put å’Œ get å¹¶å‘çš„æ—¶å€™å¯èƒ½å¯¼è‡´ get ä¸º null
çº¿ç¨‹ 1 æ‰§è¡Œ put æ—¶ï¼Œå› ä¸ºå…ƒç´ ä¸ªæ•°è¶…å‡º threshold è€Œå¯¼è‡´æ‰©å®¹ï¼Œçº¿ç¨‹ 2 æ­¤æ—¶æ‰§è¡Œ getï¼Œæœ‰å¯èƒ½å¯¼è‡´è¿™ä¸ªé—®é¢˜ã€‚
```java
Node<K,V>[] newTab = (Node<K,V>[])new Node[newCap];
table = newTab;
```
è¿™æ˜¯å› ä¸ºåœ¨ resize æ‰©å®¹æ–¹æ³•ä¸­ï¼Œæ˜¯å…ˆå°† table è®¾ç½®ä¸º newTabï¼Œç„¶åå†å¤åˆ¶çš„ï¼›
æ­¤æ—¶å¦‚æœæœ‰å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ get æ–¹æ³•ï¼Œè€Œæ–°çš„æ•°ç»„æ²¡æœ‰è¢«å¡«å……å®Œï¼Œé‚£æ­¤æ—¶è¿™ä¸ªçº¿ç¨‹å¾—åˆ°çš„å°±æ˜¯å€¼ã€‚
##### 4.3 JDK7 ä¸­å¹¶å‘ resize ä¼šé€ æˆå¾ªç¯é“¾è¡¨
JDK 7 å¯¹ resize æ–¹æ³•åœ¨å¹¶å‘æ¡ä»¶ä¸‹ï¼Œå¯èƒ½ä¼šäº§ç”Ÿå¾ªç¯é“¾è¡¨ï¼Œè¿™ä¸ªé—®é¢˜åœ¨ JDK 8 å·²ç»å¾—åˆ°äº†è§£å†³ï¼ŒJDK7 ä¸­çš„ resize æ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š
```java
void resize(int newCapacity) {
    Entry[] oldTable = table;
    int oldCapacity = oldTable.length;
    if (oldCapacity == MAXIMUM_CAPACITY) {
        threshold = Integer.MAX_VALUE;
        return;
    }

    Entry[] newTable = new Entry[newCapacity];
    transfer(newTable, initHashSeedAsNeeded(newCapacity));
    table = newTable;
    threshold = (int)Math.min(newCapacity * loadFactor, MAXIMUM_CAPACITY + 1);
}

// å…³é”®åœ¨äºè¿™ä¸ª transfer æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯å°†æ—§ hash è¡¨ä¸­çš„å…ƒç´  rehash åˆ°æ–°çš„hashè¡¨ä¸­
void transfer(Entry[] newTable, boolean rehash) {
    int newCapacity = newTable.length;
    for (Entry<K,V> e : table) {
        while(null != e) {
            Entry<K,V> next = e.next;
            if (rehash) {
                e.hash = null == e.key ? 0 : hash(e.key);
            }
            // ç”¨å…ƒç´ çš„ hash å€¼è®¡ç®—å‡ºè¿™ä¸ªå…ƒç´ åœ¨æ–°hashè¡¨ä¸­çš„ä½ç½®
            int i = indexFor(e.hash, newCapacity);
            e.next = newTable[I];
            newTable[i] = e;
            e = next;
        }
    }
}
```
JDK 7 çš„æ‰©å®¹ï¼Œé‡‡ç”¨çš„æ˜¯å¤´æ’æ³•ï¼Œä¹Ÿå°±æ˜¯å°†æ–°åŠ å…¥çš„æ•°æ®ï¼Œä½œä¸º Bucket ä¸­å­˜å‚¨çš„ç¬¬ä¸€ä¸ªæ•°æ®ï¼Œä¸‹å›¾ä¸­å±•ç¤ºçš„æ˜¯ä¸€ä¸ªæ‰©å®¹æ“ä½œï¼Œæ’å…¥çš„é¡ºåºæ˜¯ Aã€Bã€Cï¼Œä½†æ‰©å®¹ä¹‹åçš„ç»“æœé¡ºåºæ˜¯ Cã€Bã€A
![[å¤´æ’æ³•.png|700]]
å…¶å…·ä½“é€»è¾‘è¡¨ç°åœ¨è¿™æ®µä»£ç ä¸Šï¼Œe æ˜¯è¦æ’å…¥æ–° table çš„èŠ‚ç‚¹ï¼š
```java
e.next = newTable[I];
newTable[i] = e;
```
- å‡è®¾æ­¤æ—¶æœ‰ä¸€ä¸ªçº¿ç¨‹ 1ï¼Œå®ƒçš„å±€éƒ¨å˜é‡è¡¨ä¸­çš„ e å­˜å‚¨çš„æ˜¯ A èŠ‚ç‚¹ï¼Œnext å­˜å‚¨çš„æ˜¯ B èŠ‚ç‚¹ï¼Œç„¶åå…¶è¢«è°ƒåº¦ä¸‹çº¿ï¼›
- æ­¤æ—¶çº¿ç¨‹ 2ï¼Œä¹Ÿåœ¨æ‰§è¡Œ resize æ–¹æ³•ï¼Œå®ƒå°† Aã€Bã€C æ’å…¥åˆ°æ–°çš„é“¾è¡¨ä¸­ï¼›
- æ­¤æ—¶çº¿ç¨‹ 1 è¢«è°ƒåº¦ä¸Šçº¿ï¼Œå®ƒä»è®¤ä¸ºæ­¤æ—¶è¿˜æœªè¿›è¡Œè½¬ç§»ï¼Œä¾ç„¶æ‰§è¡Œï¼Œe.next = newTable\[I]; æ­¤æ—¶å°±å°† A æŒ‡å‘äº† C;
- ç„¶åç§»åŠ¨æŒ‡é’ˆï¼Œæ­¤æ—¶ e ä¸º Bï¼Œnext ä¸º nullï¼Œå†æ¬¡æ‰§è¡Œ `e.next = newTable[I]`ï¼Œè¿™æ—¶å€™åˆå°† B æŒ‡å‘äº† Cï¼Œå¾ªç¯ç»“æŸï¼š
![[JDK7 ä¸­å¹¶å‘ put ä¼šé€ æˆå¾ªç¯é“¾è¡¨.png|500]]
è¿™æ—¶å€™ï¼Œä¸€ä¸ªå¾ªç¯é“¾è¡¨å°±äº§ç”Ÿäº†ï¼Œäº§ç”Ÿè¿™ä¸ªé—®é¢˜çš„æ ¹æœ¬åŸå› å°±æ˜¯ JDK 7 å¤šä¸ªçº¿ç¨‹åœ¨æ’å…¥è¿‡ç¨‹ä¸­çš„å¹¶å‘æ“æ§ newTableï¼Œå› ä¸ºå…¶åœ¨æ–°çš„æ•°ç»„ä¸­çš„é¡ºåºå’Œæ—§çš„æ•°ç»„ä¸­æ˜¯ä¸åŒçš„ï¼Œä¼šå¯¼è‡´æŒ‡é’ˆçš„å›è¿ã€‚

åœ¨ JDK 8 çš„æ›´æ–°ä¸­ï¼ŒHashMap é€‰æ‹©åœ¨æ¯ä¸ªçº¿ç¨‹å†…éƒ¨æ„å»ºæ–°çš„ä¸¤ä¸ªé“¾è¡¨ï¼Œæ’å…¥çš„æ—¶å€™å°†è¿™äº›æ„å»ºå¥½çš„é“¾è¡¨æ•´ä½“æ’å…¥ï¼Œå„ä¸ªçº¿ç¨‹ä¹‹é—´æ„é€ çš„é“¾è¡¨äº’ä¸å½±å“ï¼Œä¸”å‡ä¸ºæ­£ç¡®çš„ï¼Œæ‰€ä»¥ä¸ç®¡æœ€ç»ˆæ•°ç»„å­˜å‚¨çš„æ˜¯å“ªä¸ªçº¿ç¨‹æ„å»ºçš„é“¾è¡¨ï¼Œç»“æœéƒ½æ˜¯æ­£ç¡®çš„ã€‚
```java
do {
	next = e.next;
	if ((e.hash & oldCap) == 0) {
		if (loTail == null) loHead = e;
		else loTail.next = e;
		loTail = e;
	}
	else {
		if (hiTail == null) hiHead = e;
		else hiTail.next = e;
		hiTail = e;
	}
} while ((e = next) != null);
```
---

JDK 7 ä¸­ï¼Œç”±äºæ‰€æœ‰çº¿ç¨‹åœ¨æ‰©å®¹çš„è¿‡ç¨‹ä¸­ï¼Œå‡æ˜¯ä¸æ–­æ“çºµå’Œæ›´æ–° newTableï¼Œå¯¼è‡´äº†æˆç¯çš„é—®é¢˜ï¼›
JDK 8 ä¹‹åï¼Œæ˜¯å…ˆå°†é“¾è¡¨æ„é€ å¥½ï¼Œå†æ’å…¥ï¼Œæ­¤æ—¶å¹¶å‘çš„æ’å…¥å¹¶ä¸ä¼šé€ æˆæœ€ç»ˆç»“æœçš„é”™è¯¯ã€‚




